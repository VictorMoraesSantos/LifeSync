<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LifeSyncApp.Views.TaskManager.TaskItem.TaskItemPage"
             xmlns:viewmodels="clr-namespace:LifeSyncApp.ViewModels.TaskManager"
             xmlns:models="clr-namespace:LifeSyncApp.Models.TaskManager"
             xmlns:enums="clr-namespace:LifeSyncApp.Models.TaskManager.Enums"
             x:DataType="viewmodels:TaskItemsViewModel"
             Title="Minhas Tarefas">

    <ScrollView Padding="10">

        <CollectionView ItemsSource="{Binding GroupedTasks}"
                            IsGrouped="True"
                            SelectionMode="None">

            <CollectionView.EmptyView>
                <StackLayout Padding="20" 
                             VerticalOptions="Center"
                             HorizontalOptions="Center">
                    <Label Text="Nenhuma tarefa encontrada"
                           FontSize="18"
                           HorizontalTextAlignment="Center"
                           TextColor="Gray" />
                </StackLayout>
            </CollectionView.EmptyView>

            <CollectionView.GroupHeaderTemplate>
                <DataTemplate x:DataType="models:TaskGroup">

                    <FlexLayout Direction="Row" AlignItems="Center" Padding="8,32,8,16" BackgroundColor="Transparent">
                        <Image Grid.Column="0"
                               Source="calendar.svg"
                               WidthRequest="16"
                               HeightRequest="16"
                               VerticalOptions="Center">
                            <Image.Triggers>
                                <DataTrigger TargetType="Image"
                                             Binding="{Binding IsOverdue}"
                                             Value="True">
                                    <Setter Property="Source" Value="calendar_alert.svg"/>
                                </DataTrigger>
                            </Image.Triggers>
                        </Image>

                        <Label Grid.Column="1"
                               Text="{Binding DisplayDate}"
                               FontSize="14"
                               FontAttributes="Bold"
                               Margin="4, 0"
                               VerticalOptions="Center">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label"
                                             Binding="{Binding IsOverdue}"
                                             Value="True">
                                    <Setter Property="TextColor" Value="#E74C3C"/>
                                </DataTrigger>
                                <DataTrigger TargetType="Label"
                                             Binding="{Binding IsOverdue}"
                                             Value="False">
                                    <Setter Property="TextColor" Value="#2C3E50"/>
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>

                        <Line X1="0" Y1="0"
          X2="1" Y2="0"
          Stroke="#000"
          StrokeThickness="2"
          VerticalOptions="Center"
          FlexLayout.Grow="1"
          Margin="0,0,8,0"/>

                        <Label HorizontalOptions="End"
                               Text="{Binding TaskCountText}"
                               FontSize="12"
                               TextColor="#95A5A6"
                               VerticalOptions="Center"
                               FlexLayout.Grow="1"/>
                    </FlexLayout>

                </DataTemplate>
            </CollectionView.GroupHeaderTemplate>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:TaskItem">

                    <Border Margin="0, 0, 0, 4" 
                            Padding="15, 15, 5, 15 "
                            StrokeShape="RoundRectangle 10,10,10,10"
                            BackgroundColor="White">

                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" 
                              Padding="0"
                              ColumnDefinitions="*,Auto"
                              RowSpacing="8">

                            <FlexLayout Direction="Row"
                                        AlignItems="Center"
                                        Padding="0, 8">
                                <Border WidthRequest="28"
                                        HeightRequest="28"
                                        StrokeShape="Ellipse"
                                        Stroke="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                        StrokeThickness="2"
                                        BackgroundColor="{Binding Status, Converter={StaticResource StatusToLightColorConverter}}">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TaskItemsViewModel}}, Path=ToggleStatusCommand}"
                                                              CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>

                                    <Label Text="{Binding Status, Converter={StaticResource StatusToIconConverter}}"
                                           FontSize="16"
                                           Padding="0"
                                           Margin="0"
                                           FlexLayout.AlignSelf="Center"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           HorizontalTextAlignment="Center"
                                           VerticalTextAlignment="Center"
                                           TextColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"/>
                                </Border>

                                <Label Text="{Binding Title}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="#2C3E50"
                                       VerticalTextAlignment="Center"
                                       FlexLayout.AlignSelf="Center"
                                       Margin="4, 0"
                                       LineBreakMode="TailTruncation">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label"
                                                     Binding="{Binding Status}"
                                                     Value="{x:Static enums:Status.Completed}">
                                            <Setter Property="TextDecorations" Value="Strikethrough"/>
                                            <Setter Property="TextColor" Value="#95A5A6"/>
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </FlexLayout>

                            <Label Text="{Binding Priority}"
                                   Grid.Row="0" 
                                   Grid.Column="1"
                                   FontSize="12"
                                   Margin="8, 0"
                                   TextColor="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                   FontAttributes="Bold"/>

                            <Label Grid.Row="1" 
                                   Grid.Column="0"
                                   Grid.ColumnSpan="2"
                                   Text="{Binding Description}"
                                   FontSize="14"
                                   TextColor="#7F8C8D"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="2"/>

                            <CollectionView Grid.Row="2"
                                            Grid.Column="0"
                                            Grid.ColumnSpan="2"
                                            ItemsSource="{Binding Labels}"
                                            IsVisible="{Binding Labels.Count, Converter={StaticResource HasItemsConverter}}">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="5"/>
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:TaskLabel">
                                        <Border Padding="8,2"
                                                StrokeShape="RoundRectangle 5,5,5,5"
                                                StrokeThickness="0"
                                                BackgroundColor="{Binding Color, Converter={StaticResource LabelColorToLightColorConverter}}">
                                            <Label Text="{Binding Name}"
                                                   FontSize="12"
                                                   TextColor="{Binding Color, Converter={StaticResource LabelColorToConverter}}"/>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                        </Grid>
                    </Border>

                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </ScrollView>

</ContentPage>
