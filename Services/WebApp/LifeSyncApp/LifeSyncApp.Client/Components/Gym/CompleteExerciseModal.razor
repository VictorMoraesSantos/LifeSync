@using LifeSyncApp.Client.Models.Gym
@using Syncfusion.Blazor.Popups

<SfDialog @bind-Visible="IsVisible" Width="600px" IsModal="true">
    <DialogTemplates>
        <Header>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span>? Completar Exercício</span>
                @if (RoutineExercise != null)
                {
                    <span class="badge badge-success">@ExerciseName</span>
                }
            </div>
        </Header>
        <Content>
            @if (RoutineExercise != null)
            {
                <div class="complete-exercise-content">
                    <!-- Proposta Original -->
                    <div class="proposed-values">
                        <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem; color: var(--text-secondary);">
                            ?? Valores Propostos:
                        </h4>
                        <div class="values-grid">
                            <div class="value-item">
                                <span class="value-label">?? Séries:</span>
                                <span class="value-number">@RoutineExercise.Sets.Value</span>
                            </div>
                            <div class="value-item">
                                <span class="value-label">?? Repetições:</span>
                                <span class="value-number">@RoutineExercise.Repetitions.Value</span>
                            </div>
                            @if (RoutineExercise.RecommendedWeight != null)
                            {
                                <div class="value-item">
                                    <span class="value-label">??? Peso:</span>
                                    <span class="value-number">@RoutineExercise.RecommendedWeight.Value @GetWeightUnit(RoutineExercise.RecommendedWeight.Unit)</span>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Pergunta se completou conforme o planejado -->
                    @if (!showCustomForm)
                    {
                        <div style="margin-top: 1.5rem; padding: 1.5rem; background: var(--surface-2); border-radius: var(--radius-sm);">
                            <p style="margin: 0 0 1rem 0; font-weight: 600; color: var(--text);">
                                ? Você completou o exercício conforme o planejado?
                            </p>
                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn btn-success" style="flex: 1;" @onclick="CompleteAsPlanned">
                                    ? Sim, exatamente como planejado
                                </button>
                                <button class="btn btn-warning" style="flex: 1;" @onclick="() => showCustomForm = true">
                                    ?? Não, preciso ajustar
                                </button>
                            </div>
                        </div>
                    }

                    <!-- Formulário customizado -->
                    @if (showCustomForm)
                    {
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem; color: var(--text-secondary);">
                                ?? Valores Realizados:
                            </h4>
                            <EditForm Model="completedModel" OnValidSubmit="SaveCustomCompletion" FormName="completeExerciseForm">
                                <div class="form-group">
                                    <label class="form-label">?? Séries Completadas</label>
                                    <InputNumber @bind-Value="completedModel.SetsCompleted" class="form-control" min="0" />
                                    <small style="color: var(--text-tertiary);">Proposto: @RoutineExercise.Sets.Value</small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">?? Repetições Completadas</label>
                                    <InputNumber @bind-Value="completedModel.RepetitionsCompleted" class="form-control" min="0" />
                                    <small style="color: var(--text-tertiary);">Proposto: @RoutineExercise.Repetitions.Value</small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">??? Peso Utilizado (kg)</label>
                                    <InputNumber @bind-Value="completedModel.WeightValue" class="form-control" min="0" />
                                    @if (RoutineExercise.RecommendedWeight != null)
                                    {
                                        <small style="color: var(--text-tertiary);">Proposto: @RoutineExercise.RecommendedWeight.Value @GetWeightUnit(RoutineExercise.RecommendedWeight.Unit)</small>
                                    }
                                </div>

                                <div class="form-group">
                                    <label class="form-label">?? Unidade</label>
                                    <InputSelect @bind-Value="completedModel.WeightUnit" class="form-control">
                                        <option value="@WeightUnitDTO.Kg">?? Quilogramas (kg)</option>
                                        <option value="@WeightUnitDTO.Lb">?? Libras (lb)</option>
                                    </InputSelect>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">?? Observações (opcional)</label>
                                    <InputTextArea @bind-Value="completedModel.Notes" class="form-control" 
                                                   placeholder="Ex: Senti dificuldade na última série..." 
                                                   rows="3" />
                                </div>

                                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                                    <button type="button" class="btn btn-secondary" @onclick="() => showCustomForm = false">
                                        ?? Voltar
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        ? Confirmar Conclusão
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    }

                    @if (!showCustomForm)
                    {
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button class="btn btn-secondary" @onclick="Close">
                                ? Cancelar
                            </button>
                        </div>
                    }
                </div>
            }
        </Content>
    </DialogTemplates>
</SfDialog>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public RoutineExerciseDTO? RoutineExercise { get; set; }
    [Parameter] public string ExerciseName { get; set; } = string.Empty;
    [Parameter] public int TrainingSessionId { get; set; }
    [Parameter] public EventCallback<CompletedExerciseModel> OnComplete { get; set; }

    private bool showCustomForm = false;
    private CompletedExerciseModel completedModel = new();

    public class CompletedExerciseModel
    {
        public int SetsCompleted { get; set; }
        public int RepetitionsCompleted { get; set; }
        public int WeightValue { get; set; }
        public WeightUnitDTO WeightUnit { get; set; } = WeightUnitDTO.Kg;
        public string? Notes { get; set; }
    }

    protected override void OnParametersSet()
    {
        if (RoutineExercise != null)
        {
            completedModel = new CompletedExerciseModel
            {
                SetsCompleted = RoutineExercise.Sets.Value,
                RepetitionsCompleted = RoutineExercise.Repetitions.Value,
                WeightValue = RoutineExercise.RecommendedWeight?.Value ?? 0,
                WeightUnit = RoutineExercise.RecommendedWeight?.Unit ?? WeightUnitDTO.Kg
            };
        }
    }

    private void Close()
    {
        IsVisible = false;
        showCustomForm = false;
        IsVisibleChanged.InvokeAsync(false);
    }

    private async Task CompleteAsPlanned()
    {
        if (RoutineExercise == null) return;

        var model = new CompletedExerciseModel
        {
            SetsCompleted = RoutineExercise.Sets.Value,
            RepetitionsCompleted = RoutineExercise.Repetitions.Value,
            WeightValue = RoutineExercise.RecommendedWeight?.Value ?? 0,
            WeightUnit = RoutineExercise.RecommendedWeight?.Unit ?? WeightUnitDTO.Kg,
            Notes = "Completado conforme o planejado"
        };

        await OnComplete.InvokeAsync(model);
        Close();
    }

    private async Task SaveCustomCompletion()
    {
        await OnComplete.InvokeAsync(completedModel);
        Close();
    }

    private string GetWeightUnit(WeightUnitDTO unit)
    {
        return unit == WeightUnitDTO.Kg ? "kg" : "lb";
    }
}
