@using LifeSyncApp.Client.Models.Nutrition.Meal
@using Syncfusion.Blazor.Popups

<SfDialog Visible="Visible" VisibleChanged="VisibleChanged" Width="520px" IsModal="true" Position="Center" AppendTo="body">
    <DialogTemplates>
        <Header>@(MealId.HasValue ? "✏️ Editar Refeição" : "🍽️ Nova Refeição")</Header>
        <Content>
            <EditForm Model="model" OnValidSubmit="HandleSubmit" FormName="mealForm">
                <div class="form-group">
                    <label class="form-label">📝 Nome</label>
                    <InputText @bind-Value="model.Name" class="form-control" placeholder="Ex: Café da manhã" />
                </div>
                <div class="form-group">
                    <label class="form-label">📄 Descrição</label>
                    <InputTextArea @bind-Value="model.Description" class="form-control" placeholder="Descrição opcional" />
                </div>
                <div style="display:flex;justify-content:flex-end;gap:.5rem;">
                    <button type="button" class="btn btn-secondary" @onclick="Cancel">❌ Cancelar</button>
                    <button type="submit" class="btn btn-primary">@(MealId.HasValue ? "💾 Salvar" : "➕ Adicionar")</button>
                </div>
            </EditForm>
        </Content>
    </DialogTemplates>
</SfDialog>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public int DiaryId { get; set; }

    // Optional editing parameters
    [Parameter] public int? MealId { get; set; }
    [Parameter] public string? InitialName { get; set; }
    [Parameter] public string? InitialDescription { get; set; }

    [Parameter] public EventCallback<CreateMealDTO> OnSubmit { get; set; }
    [Parameter] public EventCallback<LifeSyncApp.Client.Models.Nutrition.Meal.UpdateMealDTO> OnUpdate { get; set; }

    private MealInput model = new();

    private class MealInput
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }

    protected override void OnParametersSet()
    {
        // Populate model when opening for edit
        if (MealId.HasValue)
        {
            model.Name = InitialName ?? string.Empty;
            model.Description = InitialDescription ?? string.Empty;
        }
        else
        {
            // when creating, ensure DiaryId is set externally and model is fresh when opening
        }
    }

    private async Task HandleSubmit()
    {
        if (MealId.HasValue)
        {
            var dto = new LifeSyncApp.Client.Models.Nutrition.Meal.UpdateMealDTO(MealId.Value, model.Name, model.Description);
            await OnUpdate.InvokeAsync(dto);
        }
        else
        {
            var dto = new CreateMealDTO(DiaryId, model.Name, model.Description);
            await OnSubmit.InvokeAsync(dto);
        }

        model = new MealInput();
        MealId = null;
        InitialName = null;
        InitialDescription = null;
        await VisibleChanged.InvokeAsync(false);
    }

    private async Task Cancel()
    {
        model = new MealInput();
        MealId = null;
        InitialName = null;
        InitialDescription = null;
        await VisibleChanged.InvokeAsync(false);
    }
}
