@page "/financial"
@using LifeSyncApp.Client.Services
@using LifeSyncApp.Client.Models.Financial
@using LifeSyncApp.Client.Models.Financial.Category
@using LifeSyncApp.Client.Models.Financial.Transaction
@using LifeSyncApp.Client.Components.Financial
@using Syncfusion.Blazor.Popups
@inject IFinancialService FinancialService
@using System.Security.Claims

<PageTitle>Financeiro - LifeSync</PageTitle>

<RedirectToLogin>
    <PageHeader Title="Financeiro" Description="Controle suas finanças pessoais">
        <Actions>
            <div style="display:flex;gap:.5rem;">
                <button class="btn btn-secondary" @onclick="OpenCategoriesDialog">📂 Gerenciar Categorias</button>
                <button class="btn btn-primary" @onclick="OpenTransactionDialog">
                    ➕ Nova Transação
                </button>
            </div>
        </Actions>
    </PageHeader>

    <div class="stats-grid">
        <StatCard Label="Receitas" Value=@($"R$ {totalIncome.ToString("N2")}") IconStyle="success" IconText="💰">
            <div class="stat-change positive">+@incomeCount transações</div>
        </StatCard>

        <StatCard Label="Despesas" Value=@($"R$ {totalExpenses.ToString("N2")}") IconStyle="error" IconText="💸">
            <div class="stat-change negative">-@expensesCount transações</div>
        </StatCard>

        <StatCard Label="Saldo" Value=@($"R$ {balance.ToString("N2")}") IconStyle="@(balance >= 0 ? "primary" : "warning")" IconText="⚖️">
            <div class="stat-change @(balance >= 0 ? "positive" : "negative")">@(balance >= 0 ? "Positivo" : "Negativo")</div>
        </StatCard>

        <StatCard Label="Total Transações" Value="@(transactions.Count.ToString())" IconStyle="secondary" IconText="🧾" />
    </div>

    <div class="card">
        <div class="card-body">
            @if (isLoading)
            {
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading" style="width: 40px, height: 40px, border-width: 4px;"></div>
                    <p style="margin-top: 1rem;">Carregando transações...</p>
                </div>
            }
            else if (transactions.Any())
            {
                <FinancialFilters ActiveTypeFilter="activeTypeFilter"
                                  ActivePaymentFilter="activePaymentFilter"
                                  OnTypeChanged="@(t => FilterByType(t))"
                                  OnPaymentChanged="@(p => FilterByPayment(p))" />

                <div class="transactions-container">
                    @foreach (var monthGroup in GetGroupedTransactions())
                    {
                        <div class="transactions-month-section">
                            <div class="transactions-month-header">
                                <div>
                                    🗓️ @FormatMonthHeader(monthGroup.Key)
                                </div>
                                <div class="month-summary">
                                    <span class="month-income">
                                        ➕ R$ @monthGroup.Value.Where(t => t.TransactionType == TransactionType.Income).Sum(t => (decimal)t.Amount.Amount).ToString("N2")
                                    </span>
                                    <span class="month-expense">
                                        ➖ R$ @monthGroup.Value.Where(t => t.TransactionType == TransactionType.Expense).Sum(t => (decimal)t.Amount.Amount).ToString("N2")
                                    </span>
                                    <span class="month-balance @(GetMonthBalance(monthGroup.Value) >= 0 ? "month-income" : "month-expense")">
                                        💼 R$ @GetMonthBalance(monthGroup.Value).ToString("N2")
                                    </span>
                                </div>
                            </div>
                            <div class="transactions-grid">
                                @foreach (var transaction in monthGroup.Value.OrderByDescending(t => t.TransactionDate))
                                {
                                    <TransactionCard Transaction="@transaction"
                                                     OnEditClick="@(() => EditTransaction(transaction))"
                                                     OnDeleteClick="@(() => DeleteTransaction(transaction))" />
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📭</div>
                    <h3>Nenhuma transação encontrada</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Comece registrando sua primeira transação
                    </p>
                    <button class="btn btn-primary" @onclick="OpenTransactionDialog">
                        ➕ Nova Transação
                    </button>
                </div>
            }
        </div>
    </div>

    <TransactionDialog @ref="_transactionDialog" UpdateModel="UpdateTransaction" Model="TransactionModel" Categories="categories" OnSaved="SaveTransaction" />

    <CategoriesDialog @ref="_categoriesDialog" UpdateCategory="UpdateCategory" Categories="categories" OnCreate="CreateCategory" OnDelete="DeleteCategory" />

</RedirectToLogin>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;
    private int? _userId;

    private List<TransactionDTO> transactions = new();
    private List<CategoryDTO> categories = new();

    [SupplyParameterFromForm]
    private UpdateTransactionDTO UpdateTransaction { get; set; } = new();

    private TransactionDTO? TransactionModel = null;
    private bool isLoading = true;

    private UpdateCategoryDTO UpdateCategory { get; set; } = new();

    private TransactionType? activeTypeFilter = null;
    private PaymentMethod? activePaymentFilter = null;

    private decimal totalIncome => transactions.Where(t => t.TransactionType == TransactionType.Income).Sum(t => t.Amount.Amount);
    private decimal totalExpenses => transactions.Where(t => t.TransactionType == TransactionType.Expense).Sum(t => t.Amount.Amount);
    private decimal balance => totalIncome - totalExpenses;
    private int incomeCount => transactions.Count(t => t.TransactionType == TransactionType.Income);
    private int expensesCount => transactions.Count(t => t.TransactionType == TransactionType.Expense);

    private CategoriesDialog? _categoriesDialog;
    private TransactionDialog? _transactionDialog;

    protected override async Task OnInitializedAsync()
    {
        await ResolveUserIdAsync();
        await LoadCategories();
        await LoadTransactions();
    }

    private async Task ResolveUserIdAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        var id = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(id, out var parsed))
            _userId = parsed;
    }

    private async Task LoadCategories()
    {
        if (!_userId.HasValue)
            return;

        var res = await FinancialService.GetCategoriesByUserAsync(_userId.Value);
        if (res.Success && res.Data != null)
            categories = res.Data.OrderBy(c => c.Name).ToList();
    }

    private async Task LoadTransactions()
    {
        isLoading = true;

        if (!_userId.HasValue)
        {
            isLoading = false;
            return;
        }

        var result = await FinancialService.GetTransactionsByUserAsync(_userId.Value);
        if (result.Success && result.Data != null)
            transactions = result.Data.OrderByDescending(t => t.TransactionDate).ToList();

        isLoading = false;
    }

    private void FilterByType(TransactionType? type)
    {
        activeTypeFilter = type;
    }

    private void FilterByPayment(PaymentMethod? payment)
    {
        activePaymentFilter = payment;
    }

    private IEnumerable<TransactionDTO> GetFilteredTransactions()
    {
        var filtered = transactions.AsEnumerable();

        if (activeTypeFilter.HasValue)
            filtered = filtered.Where(t => t.TransactionType == activeTypeFilter.Value);

        if (activePaymentFilter.HasValue)
            filtered = filtered.Where(t => t.PaymentMethod == activePaymentFilter.Value);

        return filtered.OrderByDescending(t => t.TransactionDate);
    }

    private Dictionary<string, List<TransactionDTO>> GetGroupedTransactions()
    {
        return GetFilteredTransactions()
            .GroupBy(t => new { t.TransactionDate.Year, t.TransactionDate.Month })
            .OrderByDescending(g => g.Key.Year)
            .ThenByDescending(g => g.Key.Month)
            .ToDictionary(
                g => $"{g.Key.Year}-{g.Key.Month:D2}",
                g => g.ToList()
            );
    }

    private string FormatMonthHeader(string yearMonth)
    {
        var parts = yearMonth.Split('-');
        if (parts.Length != 2) return yearMonth;

        var year = int.Parse(parts[0]);
        var month = int.Parse(parts[1]);
        var date = new DateTime(year, month, 1);

        var today = DateTime.Today;
        var previous = today.AddMonths(-1);
        if (date.Year == today.Year && date.Month == today.Month)
            return $"Este Mês - {date:MMMM yyyy}";
        else if (date.Year == previous.Year && date.Month == previous.Month)
            return $"Mês Passado - {date:MMMM yyyy}";
        else
            return date.ToString("MMMM yyyy");
    }

    private decimal GetMonthBalance(List<TransactionDTO> monthTransactions)
    {
        var income = monthTransactions.Where(t => t.TransactionType == TransactionType.Income).Sum(t => t.Amount.Amount);
        var expense = monthTransactions.Where(t => t.TransactionType == TransactionType.Expense).Sum(t => t.Amount.Amount);
        return income - expense;
    }

    private void OpenTransactionDialog()
    {
        TransactionModel = null;
        UpdateTransaction = new UpdateTransactionDTO();
        _transactionDialog?.OnUpdate(true);
    }

    private void OpenCategoriesDialog()
    {
        UpdateCategory = new UpdateCategoryDTO();
        _categoriesDialog?.OnUpdate(true);
    }

    private void EditTransaction(TransactionDTO? transaction)
    {
        if (transaction == null) return;
        TransactionModel = transaction;
        UpdateTransaction = new UpdateTransactionDTO
        {
            Id = transaction.Id,
            Description = transaction.Description,
            Amount = new Money { Amount = transaction.Amount.Amount, Currency = transaction.Amount.Currency },
            TransactionType = transaction.TransactionType,
            CategoryId = transaction.Category?.Id,
            PaymentMethod = transaction.PaymentMethod,
            TransactionDate = transaction.TransactionDate,
            IsRecurring = transaction.IsRecurring
        };
        _transactionDialog?.OnUpdate(true);
        StateHasChanged();
    }

    private async Task SaveTransaction()
    {
        if (_userId is null) return;

        var amount = new Money
        {
            Amount = UpdateTransaction.Amount.Amount,
            Currency = UpdateTransaction.Amount.Currency
        };

        if (TransactionModel == null)
        {
            var create = new CreateTransactionDTO
            {
                UserId = _userId.Value,
                CategoryId = UpdateTransaction.CategoryId,
                PaymentMethod = UpdateTransaction.PaymentMethod,
                TransactionType = UpdateTransaction.TransactionType,
                Amount = amount,
                Description = UpdateTransaction.Description,
                TransactionDate = UpdateTransaction.TransactionDate,
                IsRecurring = UpdateTransaction.IsRecurring,
            };
            await FinancialService.CreateTransactionAsync(create);
        }
        else
        {
            var update = new UpdateTransactionDTO
            {
                Id = UpdateTransaction.Id,
                CategoryId = UpdateTransaction.CategoryId,
                PaymentMethod = UpdateTransaction.PaymentMethod,
                TransactionType = UpdateTransaction.TransactionType,
                Amount = amount,
                Description = UpdateTransaction.Description,
                TransactionDate = UpdateTransaction.TransactionDate,
                IsRecurring = UpdateTransaction.IsRecurring
            };
            await FinancialService.UpdateTransactionAsync(update);
        }

        await LoadTransactions();
        _transactionDialog?.OnUpdate(false);
        TransactionModel = null;
    }

    private async Task CreateCategory()
    {
        if (!_userId.HasValue) return;

        var cmd = new CreateCategoryDTO
        {
            UserId = _userId.Value,
            Name = UpdateCategory.Name,
            Description = UpdateCategory.Description
        };

        await FinancialService.CreateCategoryAsync(cmd);
        await LoadCategories();
        UpdateCategory = new UpdateCategoryDTO();
    }

    private async Task DeleteCategory(int id)
    {
        var res = await FinancialService.DeleteCategoryAsync(id);
        if (res.Success)
        {
            await LoadCategories();
            await LoadTransactions();
        }
    }

    private async Task DeleteTransaction(TransactionDTO? transaction)
    {
        if (transaction == null) return;

        await FinancialService.DeleteTransactionAsync(transaction.Id);
        await LoadTransactions();
        StateHasChanged();
    }

    private void CloseDialog()
    {
        _transactionDialog?.OnUpdate(false);
        TransactionModel = null;
    }

}
