@using Microsoft.AspNetCore.Components.Forms
@using Syncfusion.Blazor.Popups
@using Microsoft.AspNetCore.Components
@using LifeSyncApp.Client.Components.Financial
@using LifeSyncApp.Client.Models.Financial
@using LifeSyncApp.Client.Models.Financial.Category
@using LifeSyncApp.Client.Models.Financial.Transaction

<SfDialog Visible="@Visible" VisibleChanged="@VisibleChanged" Width="500px" IsModal="true" Position="Center" AppendTo="body">
    <DialogTemplates>
        <Header>@(EditingTransaction == null ? "➕ Nova Transação" : "✏️ Editar Transação")</Header>
        <Content>
            <EditForm Model="Model" OnValidSubmit="HandleSave" FormName="financialForm">
                <div class="form-group">
                    <label class="form-label">📝 Descrição</label>
                    <InputText @bind-Value="Model.Description" class="form-control" placeholder="Ex: Salário, Aluguel..." />
                </div>

                <div class="form-group">
                    <label class="form-label">💵 Valor</label>
                    <InputNumber @bind-Value="Model.Amount" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">💱 Moeda</label>
                    <InputSelect @bind-Value="Model.Currency" class="form-control">
                        <option value="@Currency.BRL">🇧🇷 Real (BRL)</option>
                        <option value="@Currency.USD">🇺🇸 Dólar (USD)</option>
                        <option value="@Currency.EUR">🇪🇺 Euro (EUR)</option>
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">🔁 Tipo</label>
                    <InputSelect @bind-Value="Model.TransactionType" class="form-control">
                        <option value="@TransactionType.Income">➕ Receita</option>
                        <option value="@TransactionType.Expense">➖ Despesa</option>
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">🏷️ Categoria</label>
                    <InputSelect @bind-Value="Model.CategoryId" class="form-control">
                        <option value="">Sem categoria</option>
                        @foreach (var c in Categories)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">💳 Método de Pagamento</label>
                    <InputSelect @bind-Value="Model.PaymentMethod" class="form-control">
                        <option value="@PaymentMethod.Cash">💵 Dinheiro</option>
                        <option value="@PaymentMethod.CreditCard">💳 Cartão de Crédito</option>
                        <option value="@PaymentMethod.DebitCard">🏧 Cartão de Débito</option>
                        <option value="@PaymentMethod.BankTransfer">🏦 Transferência</option>
                        <option value="@PaymentMethod.Pix">⚡ PIX</option>
                        <option value="@PaymentMethod.Other">🔖 Outro</option>
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">📅 Data</label>
                    <InputDate @bind-Value="Model.TransactionDate" class="form-control" />
                </div>

                <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                    <InputCheckbox @bind-Value="Model.IsRecurring" id="recurring-check" />
                    <label class="form-label" for="recurring-check" style="margin: 0;">♻️ Recorrente</label>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" @onclick="Close">✖️ Cancelar</button>
                    <button type="submit" class="btn btn-primary">@(EditingTransaction == null ? "➕ Criar" : "💾 Salvar")</button>
                </div>
            </EditForm>
        </Content>
    </DialogTemplates>
</SfDialog>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter] public TransactionEditModel Model { get; set; } = new TransactionEditModel();
    [Parameter] public TransactionDTO? EditingTransaction { get; set; }
    [Parameter] public List<CategoryDTO> Categories { get; set; } = new();

    [Parameter] public EventCallback OnSaved { get; set; }

    protected override void OnParametersSet()
    {
        // If parent passed an EditingTransaction ensure the form model reflects it
        if (EditingTransaction != null)
        {
            Model ??= new TransactionEditModel();
            Model.Id = EditingTransaction.Id;
            Model.Description = EditingTransaction.Description ?? string.Empty;
            Model.Amount = EditingTransaction.Amount.Amount;
            Model.Currency = EditingTransaction.Amount.Currency;
            Model.TransactionType = EditingTransaction.TransactionType;
            Model.CategoryId = EditingTransaction.Category?.Id;
            Model.PaymentMethod = EditingTransaction.PaymentMethod;
            Model.TransactionDate = EditingTransaction.TransactionDate;
            Model.IsRecurring = EditingTransaction.IsRecurring;
        }
    }

    private async Task HandleSave()
    {
        await OnSaved.InvokeAsync(null);
    }

    private async Task Close()
    {
        // Reset editing state and notify parent
        await VisibleChanged.InvokeAsync(false);
    }
}
