@using Microsoft.AspNetCore.Components.Forms
@using Syncfusion.Blazor.Popups
@using Microsoft.AspNetCore.Components
@using LifeSyncApp.Client.Components.Financial
@using LifeSyncApp.Client.Models.Financial
@using LifeSyncApp.Client.Models.Financial.Category
@using LifeSyncApp.Client.Models.Financial.Transaction

<SfDialog Visible="@Visible" VisibleChanged="@VisibleChanged" Width="500px" IsModal="true" Position="Center" AppendTo="body">
    <DialogTemplates>
        <Header>@(Model == null ? "➕ Nova Transação" : "✏️ Editar Transação")</Header>
        <Content>
            <EditForm Model="UpdateModel" OnValidSubmit="HandleSave" FormName="financialForm">
                <div class="form-group">
                    <label class="form-label">📝 Descrição</label>
                    <InputText @bind-Value="UpdateModel.Description" class="form-control" placeholder="Ex: Salário, Aluguel..." />
                </div>

                <div class="form-group">
                    <label class="form-label">💵 Valor</label>
                    <InputNumber TValue="decimal" @bind-Value="UpdateModel.Amount.Amount" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">💱 Moeda</label>
                    <InputSelect TValue="Currency" @bind-Value="UpdateModel.Amount.Currency" class="form-control">
                        <option value="@Currency.BRL">🇧🇷 Real (BRL)</option>
                        <option value="@Currency.USD">🇺🇸 Dólar (USD)</option>
                        <option value="@Currency.EUR">🇪🇺 Euro (EUR)</option>
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">🔁 Tipo</label>
                    <InputSelect TValue="TransactionType" @bind-Value="UpdateModel.TransactionType" class="form-control">
                        <option value="@TransactionType.Income">➕ Receita</option>
                        <option value="@TransactionType.Expense">➖ Despesa</option>
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">🏷️ Categoria</label>
                    <InputSelect TValue="int?" @bind-Value="UpdateModel.CategoryId" class="form-control">
                        <option value="">Sem categoria</option>
                        @foreach (var c in Categories)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">💳 Método de Pagamento</label>
                    <InputSelect TValue="PaymentMethod" @bind-Value="UpdateModel.PaymentMethod" class="form-control">
                        <option value="@PaymentMethod.Cash">💵 Dinheiro</option>
                        <option value="@PaymentMethod.CreditCard">💳 Cartão de Crédito</option>
                        <option value="@PaymentMethod.DebitCard">🏧 Cartão de Débito</option>
                        <option value="@PaymentMethod.BankTransfer">🏦 Transferência</option>
                        <option value="@PaymentMethod.Pix">⚡ PIX</option>
                        <option value="@PaymentMethod.Other">🔖 Outro</option>
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">📅 Data</label>
                    <InputDate @bind-Value="UpdateModel.TransactionDate" class="form-control" />
                </div>

                <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                    <InputCheckbox @bind-Value="UpdateModel.IsRecurring" id="recurring-check" />
                    <label class="form-label" for="recurring-check" style="margin: 0;">♻️ Recorrente</label>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" @onclick="Close">✖️ Cancelar</button>
                    <button type="submit" class="btn btn-primary">@(Model == null ? "➕ Criar" : "💾 Salvar")</button>
                </div>
            </EditForm>
        </Content>
    </DialogTemplates>
</SfDialog>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter] public UpdateTransactionDTO UpdateModel { get; set; } = new UpdateTransactionDTO();
    [Parameter] public TransactionDTO? Model { get; set; }
    [Parameter] public List<CategoryDTO> Categories { get; set; } = new();

    [Parameter] public EventCallback OnSaved { get; set; }

    protected override void OnParametersSet()
    {
        if (UpdateModel.Amount == null)
            UpdateModel.Amount = new Money();

        if (Model != null)
        {
            UpdateModel.Id = Model.Id;
            UpdateModel.Description = Model.Description ?? string.Empty;
            UpdateModel.Amount.Amount = Model.Amount.Amount;
            UpdateModel.Amount.Currency = Model.Amount.Currency;
            UpdateModel.TransactionType = Model.TransactionType;
            UpdateModel.CategoryId = Model.Category?.Id;
            UpdateModel.PaymentMethod = Model.PaymentMethod;
            UpdateModel.TransactionDate = Model.TransactionDate;
            UpdateModel.IsRecurring = Model.IsRecurring;
        }
    }

    private async Task HandleSave()
    {
        await OnSaved.InvokeAsync(null);
    }

    private async Task Close()
    {
        await VisibleChanged.InvokeAsync(false);
    }
}
