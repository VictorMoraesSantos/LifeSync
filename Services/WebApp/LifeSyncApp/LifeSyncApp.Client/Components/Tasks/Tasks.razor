@using LifeSyncApp.Client.Components.Nutrition
@using LifeSyncApp.Client.Components.Shared
@using LifeSyncApp.Client.Components.Tasks
@using LifeSyncApp.Client.Components.Tasks.Extensions
@using LifeSyncApp.Client.Models.TaskManager
@using LifeSyncApp.Client.Models.TaskManager.TaskItem
@using LifeSyncApp.Client.Models.TaskManager.TaskLabel
@using LifeSyncApp.Client.Services.Contracts
@using LifeSyncApp.Client.Services.TaskManager.Contrats
@using Syncfusion.Blazor.Popups
@using System.Security.Claims

@page "/tasks"

@inject ITaskItemService TaskItemService
@inject ITaskLabelService TaskLabelService

<PageTitle>Tarefas - LifeSync</PageTitle>

<RedirectToLogin>
    <PageHeader Title="Tarefas" Description="Gerencie suas tarefas e organize seu dia">
        <Actions>
            <div style="display:flex;gap:.5rem;">
                <button class="btn btn-primary" @onclick="OpenCreateDialog">
                    <span>Nova Tarefa</span>
                </button>
            </div>
        </Actions>
    </PageHeader>

    <StatsGrid Total="@totalTasks"
               Pending="@pendingTasks"
               InProgress="@inProgressTasks"
               Completed="@completedTasksCount" />

    <div class="card">
        <div class="card-body">
            @if (isLoading)
            {
                <div class="loading-container">
                    <div class="loading"></div>
                    <span>Carregando tarefas...</span>
                </div>
            }
            else if (_taskItems.Any())
            {
                <TaskFilters ActiveStatus="activeStatusFilter"
                             ActivePriority="activePriorityFilter"
                             OnStatusChanged="FilterByStatus"
                             OnPriorityChanged="FilterByPriority" />

                <TasksContainer GroupedTasks="_groupedTasks"
                                FormatHeader="@(d => d.ToFriendlyDateString())"
                                OnEdit="@(task => EditTask(task))"
                                OnDelete="@(task => DeleteTask(task))"
                                OnAddLabel="@(task => OpenAddLabelDialog(task))" />
            }
            else
            {
                <EmptyState Title="Nenhuma tarefa encontrada"
                            Description="Comece criando sua primeira tarefa"
                            ButtonText="Nova Tarefa"
                            OnCreate="OpenCreateDialog" />
            }
        </div>
    </div>

    <AddTaskModal @ref="_taskModal"
                  Header="@(_editingTaskItem == null ? "Nova Tarefa" : "Editar Tarefa")"
                  Model="currentTask"
                  OnSubmit="SaveTask"
                  OnCancel="CloseDialog"
                  SubmitButtonText="@(_editingTaskItem == null ? "Criar" : "Salvar")" />

    <AddLabelModal @ref="_addLabelModal"
                   Header="Adicionar Label à Tarefa"
                   Model="_labelModel"
                   OnSubmit="CreateLabelForTask"
                   OnCancel="CloseAddLabelDialog" />
</RedirectToLogin>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;
    [SupplyParameterFromForm] private UpdateTaskItemDTO currentTask { get; set; } = new();

    private bool isLoading = true;
    private int? _userId;

    private List<TaskItemDTO> _taskItems = new();
    private List<TaskLabelDTO> _labels = new();
    private TaskItemDTO? _editingTaskItem = null;

    private int? targetTaskIdForLabel = null;
    private UpdateTaskLabelDTO _labelModel { get; set; } = new();

    private Status? activeStatusFilter = null;
    private Priority? activePriorityFilter = null;

    private Dictionary<DateOnly, List<TaskItemDTO>> _groupedTasks = new();

    private string totalTasks => _taskItems.Count.ToString();
    private string pendingTasks => _taskItems.Count(t => t.Status == Status.Pending).ToString();
    private string inProgressTasks => _taskItems.Count(t => t.Status == Status.InProgress).ToString();
    private string completedTasksCount => _taskItems.Count(t => t.Status == Status.Completed).ToString();

    private AddTaskModal? _taskModal;
    private AddLabelModal? _addLabelModal;

    protected override async Task OnInitializedAsync()
    {
        await ResolveUserIdAsync();
        await Task.WhenAll(LoadLabels(), LoadTasks());
        await base.OnInitializedAsync();
    }

    private async Task ResolveUserIdAsync()
    {
        var auth = await AuthenticationStateTask;
        var idStr = auth.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        _userId = int.Parse(idStr);
    }

    private async Task LoadTasks()
    {
        isLoading = true;

        var result = await TaskItemService.GetTasksByUserAsync(_userId.Value);
        if (result.Success && result.Data != null)
        {
            _taskItems = result.Data;
            UpdateGroupedTasks();
        }

        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadLabels()
    {
        var result = await TaskLabelService.GetLabelsByUserAsync(_userId.Value);
        if (result.Success && result.Data != null)
            _labels = result.Data;

        StateHasChanged();
    }

    private void FilterByStatus(Status? status)
    {
        activeStatusFilter = status;
        UpdateGroupedTasks();
    }

    private void FilterByPriority(Priority? priority)
    {
        activePriorityFilter = priority;
        UpdateGroupedTasks();
    }

    private IEnumerable<TaskItemDTO> GetFilteredTasks()
    {
        var filtered = _taskItems.AsEnumerable();

        if (activeStatusFilter.HasValue)
            filtered = filtered.Where(t => t.Status == activeStatusFilter.Value);

        if (activePriorityFilter.HasValue)
            filtered = filtered.Where(t => t.Priority == activePriorityFilter.Value);

        return filtered.OrderBy(t => t.DueDate);
    }

    private void UpdateGroupedTasks()
    {
        _groupedTasks = GetFilteredTasks()
            .GroupBy(t => t.DueDate)
            .OrderBy(g => g.Key)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private void OpenCreateDialog()
    {
        _editingTaskItem = null;
        currentTask = new UpdateTaskItemDTO();
        _taskModal?.Open();
    }

    private void EditTask(TaskItemDTO? task)
    {
        _editingTaskItem = task;
        currentTask = new UpdateTaskItemDTO(task.Id, task.Title, task.Description, task.Status, task.Priority, task.DueDate);
        _taskModal?.Open();
        StateHasChanged();
    }

    private async Task SaveTask()
    {
        if (_editingTaskItem == null)
        {
            var create = new CreateTaskItemDTO(currentTask.Title, currentTask.Description, currentTask.Priority, currentTask.DueDate, _userId.Value);
            await TaskItemService.CreateTaskAsync(create);
        }
        else
        {
            var update = new UpdateTaskItemDTO(currentTask.Id, currentTask.Title, currentTask.Description, currentTask.Status, currentTask.Priority, currentTask.DueDate);
            await TaskItemService.UpdateTaskAsync(update);
        }

        await LoadTasks();
        CloseDialog();
        StateHasChanged();
    }

    private async Task DeleteTask(TaskItemDTO? task)
    {
        await TaskItemService.DeleteTaskAsync(task.Id);
        await LoadTasks();
        StateHasChanged();
    }

    private void CloseDialog()
    {
        _taskModal?.Close();
        currentTask = new();
        _editingTaskItem = null;
    }

    private async Task CreateLabel()
    {
        var cmd = new CreateTaskLabelDTO(_labelModel.Name, _labelModel.Color, _userId.Value, 0);
        var res = await TaskLabelService.CreateLabelAsync(cmd);
        if (res.Success)
            await LoadLabels();
        StateHasChanged();
    }

    private async Task DeleteLabel(int id)
    {
        var res = await TaskLabelService.DeleteLabelAsync(id);
        if (!res.Success) return;

        await LoadLabels();
        await LoadTasks();
    }

    private void OpenAddLabelDialog(TaskItemDTO? task)
    {
        targetTaskIdForLabel = task.Id;
        _labelModel = new();
        _addLabelModal?.Open();
        StateHasChanged();
    }

    private void CloseAddLabelDialog()
    {
        _addLabelModal?.Close();
        _labelModel = new UpdateTaskLabelDTO();
        targetTaskIdForLabel = null;
    }

    private async Task CreateLabelForTask()
    {
        var cmd = new CreateTaskLabelDTO(_labelModel.Name, _labelModel.Color, _userId.Value, targetTaskIdForLabel.Value);
        var res = await TaskLabelService.CreateLabelAsync(cmd);
        if (!res.Success) return;

        _addLabelModal?.Close();
        _labelModel = new();
        await LoadTasks();
        StateHasChanged();
    }
}
