@page "/nutrition"
@using LifeSyncApp.Client.Services
@using LifeSyncApp.Client.Models.Nutrition
@using LifeSyncApp.Client.Components.Nutrition
@using Syncfusion.Blazor.Popups
@inject INutritionService NutritionService
@using System.Security.Claims

<PageTitle>Nutrição - LifeSync</PageTitle>

<RedirectToLogin>
    <PageHeader Title="Nutrição" Description="Acompanhe suas refeições e hidratação">
        <Actions>
            <div style="display:flex;gap:.5rem;">
                <button class="btn btn-secondary" @onclick="OpenGoalDialog">⚙️ Definir Objetivo</button>
                <button class="btn btn-primary" @onclick="EnsureTodayDiary">➕ Criar Diário de Hoje</button>
            </div>
        </Actions>
    </PageHeader>

    <div class="stats-grid">
        <StatCard Label="Calorias Hoje" Value="@todayCalories.ToString()" IconStyle="warning" IconText="🔥">
            <div class="stat-change">Meta: @goalCalories kcal</div>
        </StatCard>

        <StatCard Label="Refeições" Value="@todayMeals.ToString()" IconStyle="success" IconText="🍽️" />

        <StatCard Label="Líquidos" Value=@($"{todayLiquids:0.0} L") IconStyle="primary" IconText="💧">
            <div class="stat-change">Meta: @goalLiters.ToString("0.0") L</div>
        </StatCard>

        <StatCard Label="Dias Registrados" Value="@diariesCount.ToString()" IconStyle="secondary" IconText="📅" />
    </div>

    <div class="nutrition-layout">
        <div>
            @if (isLoadingMeals)
            {
                <div class="card">
                    <div class="card-body">
                        <div style="text-align: center; padding: 3rem;">
                            <div class="loading" style="width: 40px; height: 40px; border-width: 4px;"></div>
                            <p style="margin-top: 1rem;">Carregando diários...</p>
                        </div>
                    </div>
                </div>
            }
            else if (allDiaries.Any())
            {
                <div class="filter-buttons" style="margin-bottom: 1.5rem;">
                    <button class="filter-btn @(selectedDateFilter == DateFilter.All ? "active" : "")"
                            @onclick="() => FilterByDate(DateFilter.All)">
                        📋 Todos
                    </button>
                    <button class="filter-btn @(selectedDateFilter == DateFilter.Today ? "active" : "")"
                            @onclick="() => FilterByDate(DateFilter.Today)">
                        ☀️ Hoje
                    </button>
                    <button class="filter-btn @(selectedDateFilter == DateFilter.ThisWeek ? "active" : "")"
                            @onclick="() => FilterByDate(DateFilter.ThisWeek)">
                        📆 Esta Semana
                    </button>
                    <button class="filter-btn @(selectedDateFilter == DateFilter.ThisMonth ? "active" : "")"
                            @onclick="() => FilterByDate(DateFilter.ThisMonth)">
                        🗓️ Este Mês
                    </button>
                </div>

                <div class="diaries-container">
                    @foreach (var dateGroup in GetGroupedDiaries())
                    {
                        <div class="diaries-date-section">
                            <div class="diaries-date-header">
                                @FormatDateHeader(dateGroup.Key)
                            </div>
                            @foreach (var diary in dateGroup.Value)
                            {
                                <DiaryCard Diary="@diary"
                                           OnAddMeal="@(() => OpenAddMealDialog(diary))"
                                           OnAddWater="@(() => OpenAddWaterDialog(diary))"
                                           OnEditMeal="@((meal) => EditMeal(meal))"
                                           OnAddFood="@((meal) => OpenAddFoodDialog(meal))" />
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body">
                        <div style="text-align: center; padding: 3rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
                            <h3>Nenhum diário encontrado</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Comece criando seu diário de hoje
                            </p>
                            <button class="btn btn-primary" @onclick="EnsureTodayDiary">
                                ➕ Criar Diário de Hoje
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div>
            <ProgressPanel CurrentCalories="@todayCalories"
                           GoalCalories="@goalCalories"
                           CurrentLiters="@todayLiquids"
                           GoalLiters="@goalLiters"
                           TotalMeals="@todayMeals"
                           TotalDays="@diariesCount"
                           OnEditGoals="@OpenGoalDialog"
                           OnAddWater="@AddWater" />
        </div>
    </div>

    <!-- Dialog de Objetivo / Consumo -->
    <SfDialog @bind-Visible="showGoalDialog" Width="520px" IsModal="true">
        <DialogTemplates>
            <Header>⚙️ Objetivo Diário</Header>
            <Content>
                <div class="form-group">
                    <label class="form-label">🔥 Calorias (kcal)</label>
                    <InputNumber @bind-Value="goalCalories" class="form-control" />
                </div>
                <div class="form-group">
                    <label class="form-label">💧 Líquidos (ml)</label>
                    <InputNumber @bind-Value="goalMl" class="form-control" />
                </div>
                <div style="display:flex;justify-content:flex-end;gap:.5rem;">
                    <button class="btn btn-secondary" @onclick="() => showGoalDialog = false">❌ Cancelar</button>
                    <button class="btn btn-primary" @onclick="SaveGoal" disabled="@(todayProgressId is null)">💾 Salvar</button>
                </div>
            </Content>
        </DialogTemplates>
    </SfDialog>

    <!-- Dialog de Adicionar Refeição -->
    <SfDialog @bind-Visible="showAddMealDialog" Width="520px" IsModal="true">
        <DialogTemplates>
            <Header>🍽️ Nova Refeição</Header>
            <Content>
                <EditForm Model="mealModel" OnValidSubmit="SaveMeal" FormName="mealForm">
                    <div class="form-group">
                        <label class="form-label">📝 Nome</label>
                        <InputText @bind-Value="mealModel.Name" class="form-control" placeholder="Ex: Café da manhã" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">📄 Descrição</label>
                        <InputTextArea @bind-Value="mealModel.Description" class="form-control" placeholder="Descrição opcional" />
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:.5rem;">
                        <button type="button" class="btn btn-secondary" @onclick="() => showAddMealDialog = false">❌ Cancelar</button>
                        <button type="submit" class="btn btn-primary">➕ Adicionar</button>
                    </div>
                </EditForm>
            </Content>
        </DialogTemplates>
    </SfDialog>

    <!-- Dialog de Adicionar Alimento -->
    <SfDialog @bind-Visible="showAddFoodDialog" Width="520px" IsModal="true">
        <DialogTemplates>
            <Header>🥗 Adicionar Alimento</Header>
            <Content>
                <EditForm Model="foodModel" OnValidSubmit="SaveFood" FormName="foodForm">
                    <div class="form-group">
                        <label class="form-label">🍴 Nome</label>
                        <InputText @bind-Value="foodModel.Name" class="form-control" placeholder="Ex: Arroz integral" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">⚖️ Quantidade (gramas)</label>
                        <InputNumber @bind-Value="foodModel.QuantityInGrams" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">🔥 Calorias por grama</label>
                        <InputNumber @bind-Value="foodModel.CaloriesPerUnit" class="form-control" />
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:.5rem;">
                        <button type="button" class="btn btn-secondary" @onclick="() => showAddFoodDialog = false">❌ Cancelar</button>
                        <button type="submit" class="btn btn-primary">➕ Adicionar</button>
                    </div>
                </EditForm>
            </Content>
        </DialogTemplates>
    </SfDialog>

    <!-- Dialog de Adicionar Água -->
    <SfDialog @bind-Visible="showAddWaterDialog" Width="420px" IsModal="true">
        <DialogTemplates>
            <Header>💧 Adicionar Líquido</Header>
            <Content>
                <div class="form-group">
                    <label class="form-label">🏷️ Nome</label>
                    <InputText @bind-Value="waterName" class="form-control" placeholder="Ex: Água" />
                </div>
                <div class="form-group">
                    <label class="form-label">🥤 Quantidade (ml)</label>
                    <InputNumber @bind-Value="waterQuantity" class="form-control" />
                </div>
                <div style="display:flex;justify-content:flex-end;gap:.5rem;">
                    <button class="btn btn-secondary" @onclick="() => showAddWaterDialog = false">❌ Cancelar</button>
                    <button class="btn btn-primary" @onclick="SaveWater">➕ Adicionar</button>
                </div>
            </Content>
        </DialogTemplates>
    </SfDialog>
</RedirectToLogin>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;
    private int? _userId;

    private enum DateFilter { All, Today, ThisWeek, ThisMonth }

    private class MealModel
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }

    private class FoodModel
    {
        public string Name { get; set; } = string.Empty;
        public int QuantityInGrams { get; set; }
        public int CaloriesPerUnit { get; set; }
    }

    private List<DiaryDTO> allDiaries = new();
    private DiaryDTO? todayDiary = null;
    private bool isLoadingMeals = true;
    private int diariesCount = 0;

    private int todayCalories => todayDiary?.TotalCalories ?? 0;
    private int todayMeals => todayDiary?.Meals.Count ?? 0;
    private decimal todayLiquids => (todayDiary?.Liquids.Sum(l => l.QuantityMl) ?? 0) / 1000m;

    // Objetivos e progresso diário
    private int goalCalories = 2000;
    private decimal goalLiters => goalMl / 1000m;
    private int goalMl = 2500;
    private int? todayProgressId = null;

    // Filtros
    private DateFilter selectedDateFilter = DateFilter.All;

    // Dialogs
    private bool showGoalDialog = false;
    private bool showAddMealDialog = false;
    private bool showAddFoodDialog = false;
    private bool showAddWaterDialog = false;

    // Models
    private MealModel mealModel = new();
    private FoodModel foodModel = new();
    private DiaryDTO? selectedDiary = null;
    private MealDTO? selectedMeal = null;
    private string waterName = "Água";
    private int waterQuantity = 250;

    protected override async Task OnInitializedAsync()
    {
        await ResolveUserIdAsync();
        await LoadNutritionData();
        await EnsureDailyProgress();
    }

    private async Task ResolveUserIdAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        var idStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                   ?? user.FindFirst("UserId")?.Value
                   ?? user.FindFirst("sub")?.Value;
        if (int.TryParse(idStr, out var id))
            _userId = id;
    }

    private async Task LoadNutritionData()
    {
        isLoadingMeals = true;
        if (_userId is null)
        {
            allDiaries = new();
            todayDiary = null;
            diariesCount = 0;
            return;
        }

        var diariesResult = await NutritionService.GetDiariesByUserAsync(_userId.Value);
        if (diariesResult.Success && diariesResult.Data != null)
        {
            allDiaries = diariesResult.Data.OrderByDescending(d => d.Date).ToList();
            diariesCount = allDiaries.Count;
            var today = DateOnly.FromDateTime(DateTime.Today);
            todayDiary = allDiaries.FirstOrDefault(d => d.Date == today);
        }
        isLoadingMeals = false;
    }

    private void FilterByDate(DateFilter filter)
    {
        selectedDateFilter = filter;
    }

    private IEnumerable<DiaryDTO> GetFilteredDiaries()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);

        return selectedDateFilter switch
        {
            DateFilter.Today => allDiaries.Where(d => d.Date == today),
            DateFilter.ThisWeek => allDiaries.Where(d => d.Date >= today.AddDays(-7)),
            DateFilter.ThisMonth => allDiaries.Where(d => d.Date.Month == today.Month && d.Date.Year == today.Year),
            _ => allDiaries
        };
    }

    private Dictionary<DateOnly, List<DiaryDTO>> GetGroupedDiaries()
    {
        return GetFilteredDiaries()
            .GroupBy(d => d.Date)
            .OrderByDescending(g => g.Key)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private string FormatDateHeader(DateOnly date)
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var yesterday = today.AddDays(-1);

        if (date == today)
            return $"📅 Hoje - {date:dd/MM/yyyy}";
        else if (date == yesterday)
            return $"🕐 Ontem - {date:dd/MM/yyyy}";
        else
            return $"📆 {date:dd/MM/yyyy - dddd}";
    }

    private async Task EnsureTodayDiary()
    {
        await EnsureDiaryInternal();
        await LoadNutritionData();
    }

    private async Task EnsureDiaryInternal()
    {
        if (_userId is null) return;
        var today = DateOnly.FromDateTime(DateTime.Today);
        if (todayDiary == null)
        {
            var create = new CreateDiaryCommand(_userId.Value, today);
            await NutritionService.CreateDiaryAsync(create);
        }
    }

    private async Task EnsureDailyProgress()
    {
        try
        {
            if (_userId is null) return;
            var res = await NutritionService.GetDailyProgressesByUserAsync(_userId.Value);
            var today = DateOnly.FromDateTime(DateTime.Today);
            var todayProgress = res.Success ? res.Data?.FirstOrDefault(p => p.Date == today) : null;
            if (todayProgress == null)
            {
                var create = new CreateDailyProgressCommand(_userId.Value, today, 0, 0);
                var created = await NutritionService.CreateDailyProgressAsync(create);
                if (created.Success)
                {
                    res = await NutritionService.GetDailyProgressesByUserAsync(_userId.Value);
                    todayProgress = res.Data?.FirstOrDefault(p => p.Date == today);
                }
            }

            if (todayProgress != null)
            {
                todayProgressId = todayProgress.Id;
                goalCalories = todayProgress.Goal?.Calories ?? goalCalories;
                goalMl = todayProgress.Goal?.QuantityMl ?? goalMl;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error ensuring daily progress: {ex.Message}");
        }
    }

    private void OpenAddMealDialog(DiaryDTO diary)
    {
        selectedDiary = diary;
        mealModel = new MealModel();
        showAddMealDialog = true;
        this.StateHasChanged();
    }

    private async Task SaveMeal()
    {
        if (selectedDiary == null) return;
        var cmd = new CreateMealCommand(selectedDiary.Id, mealModel.Name, mealModel.Description);
        await NutritionService.AddMealAsync(cmd);
        await LoadNutritionData();
        showAddMealDialog = false;
        this.StateHasChanged();
    }

    private void EditMeal(MealDTO meal)
    {
        // TODO: Implementar edição de refeição
        Console.WriteLine($"Edit meal: {meal.Name}");
    }

    private void OpenAddFoodDialog(MealDTO meal)
    {
        selectedMeal = meal;
        foodModel = new FoodModel();
        showAddFoodDialog = true;
        this.StateHasChanged();
    }

    private async Task SaveFood()
    {
        if (selectedMeal == null) return;
        var cmd = new CreateMealFoodCommand(selectedMeal.Id, foodModel.Name, foodModel.QuantityInGrams, foodModel.CaloriesPerUnit);
        await NutritionService.AddMealFoodAsync(cmd);
        await LoadNutritionData();
        showAddFoodDialog = false;
        this.StateHasChanged();
    }

    private void OpenAddWaterDialog(DiaryDTO diary)
    {
        selectedDiary = diary;
        waterName = "Água";
        waterQuantity = 250;
        showAddWaterDialog = true;
        this.StateHasChanged();
    }

    private async Task SaveWater()
    {
        if (selectedDiary == null) return;
        var liquid = new CreateLiquidCommand(selectedDiary.Id, waterName, waterQuantity, 0);
        await NutritionService.AddLiquidAsync(liquid);
        await LoadNutritionData();
        showAddWaterDialog = false;
        this.StateHasChanged();
    }

    private async Task AddWater(int ml)
    {
        await EnsureDiaryInternal();
        if (todayDiary == null) return;
        var liquid = new CreateLiquidCommand(todayDiary.Id, "Água", ml, 0);
        await NutritionService.AddLiquidAsync(liquid);
        await LoadNutritionData();
        this.StateHasChanged();
    }

    private void OpenGoalDialog()
    {
        showGoalDialog = true;
    }

    private async Task SaveGoal()
    {
        if (todayProgressId is null) return;
        var goal = new DailyGoalDTO(goalCalories, goalMl);
        await NutritionService.SetGoalAsync(todayProgressId.Value, goal);
        showGoalDialog = false;
        this.StateHasChanged();
    }
}
