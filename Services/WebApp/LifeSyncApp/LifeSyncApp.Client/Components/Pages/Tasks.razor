@page "/tasks"
@using LifeSyncApp.Client.Services
@using LifeSyncApp.Client.Models.TaskManager
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Popups
@inject ITaskManagerService TaskService

<PageTitle>Tarefas - LifeSync</PageTitle>

<div class="content-header">
    <div>
        <h1 class="page-title">Tarefas</h1>
        <p class="page-description">Gerencie suas tarefas e organize seu dia</p>
    </div>
    <button class="btn btn-primary" @onclick="OpenCreateDialog">
        <span>+ Nova Tarefa</span>
    </button>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-value">@totalTasks</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-icon primary">
                <span>??</span>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-value">@pendingTasks</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-icon warning">
                <span>?</span>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-value">@inProgressTasks</div>
                <div class="stat-label">Em Progresso</div>
            </div>
            <div class="stat-icon secondary">
                <span>??</span>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-value">@completedTasksCount</div>
                <div class="stat-label">Concluídas</div>
            </div>
            <div class="stat-icon success">
                <span>?</span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        @if (isLoading)
        {
            <div style="text-align: center; padding: 3rem;">
                <div class="loading" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p style="margin-top: 1rem;">Carregando tarefas...</p>
            </div>
        }
        else if (tasks.Any())
        {
            <SfGrid DataSource="@tasks" AllowPaging="true" AllowSorting="true" AllowFiltering="true">
                <GridPageSettings PageSize="10"></GridPageSettings>
                <GridColumns>
                    <GridColumn Field="@nameof(TaskItemDTO.Title)" HeaderText="Título" Width="200"></GridColumn>
                    <GridColumn Field="@nameof(TaskItemDTO.Description)" HeaderText="Descrição" Width="250"></GridColumn>
                    <GridColumn Field="@nameof(TaskItemDTO.Priority)" HeaderText="Prioridade" Width="120">
                        <Template>
                            @{
                                var task = context as TaskItemDTO;
                                <span class="badge badge-@GetPriorityColor(task?.Priority ?? Priority.Medium)">
                                    @task?.Priority
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(TaskItemDTO.Status)" HeaderText="Status" Width="120"></GridColumn>
                    <GridColumn Field="@nameof(TaskItemDTO.DueDate)" HeaderText="Data" Width="120" Format="dd/MM/yyyy"></GridColumn>
                    <GridColumn HeaderText="Ações" Width="150">
                        <Template>
                            @{
                                var task = context as TaskItemDTO;
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" @onclick="() => EditTask(task)">
                                        Editar
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteTask(task)">
                                        Excluir
                                    </button>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        }
        else
        {
            <div style="text-align: center; padding: 3rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
                <h3>Nenhuma tarefa encontrada</h3>
                <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">
                    Comece criando sua primeira tarefa
                </p>
                <button class="btn btn-primary" @onclick="OpenCreateDialog">
                    + Nova Tarefa
                </button>
            </div>
        }
    </div>
</div>

<SfDialog @bind-Visible="showDialog" Width="500px" IsModal="true">
    <DialogTemplates>
        <Header>@(editingTask == null ? "Nova Tarefa" : "Editar Tarefa")</Header>
        <Content>
            <EditForm Model="currentTask" OnValidSubmit="SaveTask" FormName="taskForm">
                <div class="form-group">
                    <label class="form-label">Título</label>
                    <InputText @bind-Value="currentTask.Title" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <InputTextArea @bind-Value="currentTask.Description" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">Prioridade</label>
                    <InputSelect @bind-Value="currentTask.Priority" class="form-control">
                        @foreach (var p in Enum.GetValues<Priority>())
                        {
                            <option value="@p">@p</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <InputSelect @bind-Value="currentTask.Status" class="form-control">
                        @foreach (var s in Enum.GetValues<Status>())
                        {
                            <option value="@s">@s</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Data de Vencimento</label>
                    <InputDate DateFormat="dd/MM/yyyy" @bind-Value="currentTask.DueDate" class="form-control" />
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDialog">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        @(editingTask == null ? "Criar" : "Salvar")
                    </button>
                </div>
            </EditForm>
        </Content>
    </DialogTemplates>
</SfDialog>

@code {
    private class TaskEditModel
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public Status Status { get; set; } = Status.Pending;
        public Priority Priority { get; set; } = Priority.Medium;
        public DateOnly DueDate { get; set; } = DateOnly.FromDateTime(DateTime.Today);
    }

    private List<TaskItemDTO> tasks = new();

    [SupplyParameterFromForm]
    private TaskEditModel currentTask { get; set; } = new();

    private TaskItemDTO? editingTask = null;
    private bool showDialog = false;
    private bool isLoading = true;

    private int totalTasks => tasks.Count;
    private int pendingTasks => tasks.Count(t => t.Status == Status.Pending);
    private int inProgressTasks => tasks.Count(t => t.Status == Status.InProgress);
    private int completedTasksCount => tasks.Count(t => t.Status == Status.Completed);

    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
    }

    private async Task LoadTasks()
    {
        isLoading = true;
        try
        {
            var result = await TaskService.GetTasksAsync();
            if (result.Success && result.Data != null)
            {
                tasks = result.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tasks: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenCreateDialog()
    {
        editingTask = null;
        currentTask = new TaskEditModel();
        showDialog = true;
    }

    private void EditTask(TaskItemDTO? task)
    {
        if (task == null) return;
        editingTask = task;
        currentTask = new TaskEditModel
        {
            Id = task.Id,
            Title = task.Title,
            Description = task.Description,
            Status = task.Status,
            Priority = task.Priority,
            DueDate = task.DueDate
        };
        showDialog = true;
    }

    private async Task SaveTask()
    {
        try
        {
            if (editingTask == null)
            {
                var create = new CreateTaskItemCommand(currentTask.Title, currentTask.Description, currentTask.Priority, currentTask.DueDate, 0);
                await TaskService.CreateTaskAsync(create);
            }
            else
            {
                var update = new UpdateTaskItemCommand(currentTask.Id, currentTask.Title, currentTask.Description, currentTask.Status, currentTask.Priority, currentTask.DueDate);
                await TaskService.UpdateTaskAsync(update);
            }

            await LoadTasks();
            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving task: {ex.Message}");
        }
    }

    private async Task DeleteTask(TaskItemDTO? task)
    {
        if (task == null) return;

        try
        {
            await TaskService.DeleteTaskAsync(task.Id);
            await LoadTasks();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting task: {ex.Message}");
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
        currentTask = new();
        editingTask = null;
    }

    private string GetPriorityColor(Priority priority)
    {
        return priority switch
        {
            Priority.High => "error",
            Priority.Urgent => "error",
            Priority.Medium => "warning",
            Priority.Low => "secondary",
            _ => "primary"
        };
    }
}
