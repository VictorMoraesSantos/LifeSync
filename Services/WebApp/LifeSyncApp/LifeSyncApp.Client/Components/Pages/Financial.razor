@page "/financial"
@using LifeSyncApp.Client.Services
@using LifeSyncApp.Client.Models.Financial
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@inject IFinancialService FinancialService
@using System.Security.Claims

<PageTitle>Financeiro - LifeSync</PageTitle>

<RedirectToLogin>
<PageHeader Title="Financeiro" Description="Controle suas finanças pessoais">
    <Actions>
        <div style="display:flex;gap:.5rem;">
            <button class="btn btn-secondary" @onclick="OpenCategoriesDialog">Gerenciar Categorias</button>
            <button class="btn btn-primary" @onclick="OpenCreateDialog">
                + Nova Transação
            </button>
        </div>
    </Actions>
</PageHeader>

<div class="stats-grid">
        <StatCard Label="Receitas" Value=@($"R$ {totalIncome.ToString("N2")}") IconStyle="success" IconText="??">
        <div class="stat-change positive">+@incomeCount transações</div>
    </StatCard>

    <StatCard Label="Despesas" Value=@($"R$ {totalExpenses.ToString("N2")}") IconStyle="error" IconText="??">
        <div class="stat-change negative">-@expensesCount transações</div>
    </StatCard>

    <StatCard Label="Saldo" Value=@($"R$ {balance.ToString("N2")}") IconStyle="@(balance >= 0 ? "primary" : "warning")" IconText="??">
        <div class="stat-change @(balance >= 0 ? "positive" : "negative")">@(balance >= 0 ? "Positivo" : "Negativo")</div>
    </StatCard>

    <StatCard Label="Total Transações" Value="@(transactions.Count.ToString())" IconStyle="secondary" IconText="??" />
</div>

<div class="card">
    <div class="card-body">
        @if (isLoading)
        {
            <div style="text-align: center; padding: 3rem;">
                <div class="loading" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p style="margin-top: 1rem;">Carregando transações...</p>
            </div>
        }
        else if (transactions.Any())
        {
            <SfGrid DataSource="@transactions" AllowPaging="true" AllowSorting="true" AllowFiltering="true">
                <GridPageSettings PageSize="10"></GridPageSettings>
                <GridColumns>
                    <GridColumn Field="@nameof(TransactionDTO.Description)" HeaderText="Descrição" Width="200"></GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.Amount)" HeaderText="Valor" Width="120"></GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.TransactionType)" HeaderText="Tipo" Width="100">
                        <Template>
                            @{
                                var transaction = context as TransactionDTO;
                                <span class="badge badge-@(transaction?.TransactionType == TransactionType.Income ? "success" : "error")">
                                    @(transaction?.TransactionType == TransactionType.Income ? "Receita" : "Despesa")
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn HeaderText="Categoria" Width="150">
                        <Template>
                            @{
                                var transaction = context as TransactionDTO;
                                @transaction?.Category?.Name
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.PaymentMethod)" HeaderText="Método" Width="120"></GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.TransactionDate)" HeaderText="Data" Width="120" Format="dd/MM/yyyy"></GridColumn>
                    <GridColumn HeaderText="Ações" Width="150">
                        <Template>
                            @{
                                var transaction = context as TransactionDTO;
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" @onclick="() => EditTransaction(transaction)">
                                        Editar
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteTransaction(transaction)">
                                        Excluir
                                    </button>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        }
        else
        {
            <div style="text-align: center; padding: 3rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
                <h3>Nenhuma transação encontrada</h3>
                <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">
                    Comece registrando sua primeira transação
                </p>
                <button class="btn btn-primary" @onclick="OpenCreateDialog">
                    + Nova Transação
                </button>
            </div>
        }
    </div>
</div>

<SfDialog @bind-Visible="showDialog" Width="500px" IsModal="true">
    <DialogTemplates>
        <Header>@(editingTransaction == null ? "Nova Transação" : "Editar Transação")</Header>
        <Content>
            <EditForm Model="editModel" OnValidSubmit="SaveTransaction" FormName="financialForm">
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <InputText @bind-Value="editModel.Description" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">Valor</label>
                    <InputNumber @bind-Value="editModel.Amount" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">Moeda</label>
                    <InputSelect @bind-Value="editModel.Currency" class="form-control">
                        @foreach (var c in Enum.GetValues<Currency>())
                        {
                            <option value="@c">@c</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <InputSelect @bind-Value="editModel.TransactionType" class="form-control">
                        @foreach (var t in Enum.GetValues<TransactionType>())
                        {
                            <option value="@t">@t</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <InputSelect @bind-Value="editModel.CategoryId" class="form-control">
                        <option value="">Sem categoria</option>
                        @foreach (var c in categories)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Método de Pagamento</label>
                    <InputSelect @bind-Value="editModel.PaymentMethod" class="form-control">
                        @foreach (var m in Enum.GetValues<PaymentMethod>())
                        {
                            <option value="@m">@m</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Data</label>
                    <InputDate @bind-Value="editModel.TransactionDate" class="form-control" />
                </div>

                <div class="form-group">
                    <InputCheckbox @bind-Value="editModel.IsRecurring" />
                    <label class="form-label" style="margin-left: 0.5rem;">Recorrente</label>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDialog">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        @(editingTransaction == null ? "Criar" : "Salvar")
                    </button>
                </div>
            </EditForm>
        </Content>
    </DialogTemplates>
</SfDialog>

<!-- Dialogo de gerenciamento de Categorias -->
<SfDialog @bind-Visible="showCategoriesDialog" Width="620px" IsModal="true">
    <DialogTemplates>
        <Header>Gerenciar Categorias</Header>
        <Content>
            <div class="form-group">
                <label class="form-label">Nome</label>
                <InputText @bind-Value="categoryModel.Name" class="form-control" />
            </div>
            <div class="form-group">
                <label class="form-label">Descrição</label>
                <InputText @bind-Value="categoryModel.Description" class="form-control" />
            </div>
            <div style="display:flex;justify-content:flex-end;gap:.5rem;">
                <button class="btn btn-secondary" @onclick="() => { categoryModel = new CategoryEditModel(); showCategoriesDialog = false; }">Fechar</button>
                <button class="btn btn-primary" @onclick="CreateCategory">Adicionar Categoria</button>
            </div>

            <div class="card" style="margin-top:1rem;">
                <div class="card-header"><h3 class="card-title">Minhas categorias</h3></div>
                <div class="card-body">
                    @if (categories.Any())
                    {
                        <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
                            @foreach (var c in categories)
                            {
                                <div style="display:flex;align-items:center;gap:.5rem;background:var(--surface-2);border:1px solid var(--border);padding:.35rem .5rem;border-radius:10px;">
                                    <span class="badge badge-primary">@c.Name</span>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteCategory(c.Id)">Excluir</button>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <span style="color:var(--text-tertiary);">Nenhuma categoria criada</span>
                    }
                </div>
            </div>
        </Content>
    </DialogTemplates>
</SfDialog>
</RedirectToLogin>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;
    private int? _userId;

    private class TransactionEditModel
    {
        public int Id { get; set; }
        public string Description { get; set; } = string.Empty;
        public int Amount { get; set; }
        public Currency Currency { get; set; } = Currency.BRL;
        public TransactionType TransactionType { get; set; } = TransactionType.Expense;
        public int? CategoryId { get; set; }
        public PaymentMethod PaymentMethod { get; set; } = PaymentMethod.Cash;
        public DateTime TransactionDate { get; set; } = DateTime.Today;
        public bool IsRecurring { get; set; }
    }

    private class CategoryEditModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
    }

    private List<TransactionDTO> transactions = new();
    private List<CategoryDTO> categories = new();

    [SupplyParameterFromForm]
    private TransactionEditModel editModel { get; set; } = new();

    private TransactionDTO? editingTransaction = null;
    private bool showDialog = false;
    private bool isLoading = true;

    private bool showCategoriesDialog = false;
    private CategoryEditModel categoryModel { get; set; } = new();

    private decimal totalIncome => transactions.Where(t => t.TransactionType == TransactionType.Income).Sum(t => (decimal)t.Amount.Amount);
    private decimal totalExpenses => transactions.Where(t => t.TransactionType == TransactionType.Expense).Sum(t => (decimal)t.Amount.Amount);
    private decimal balance => totalIncome - totalExpenses;
    private int incomeCount => transactions.Count(t => t.TransactionType == TransactionType.Income);
    private int expensesCount => transactions.Count(t => t.TransactionType == TransactionType.Expense);

    protected override async Task OnInitializedAsync()
    {
        await ResolveUserIdAsync();
        await Task.WhenAll(LoadCategories(), LoadTransactions());
    }

    private async Task ResolveUserIdAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        var idStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                   ?? user.FindFirst("UserId")?.Value
                   ?? user.FindFirst("sub")?.Value;
        if (int.TryParse(idStr, out var id))
            _userId = id;
    }

    private async Task LoadCategories()
    {
        try
        {
            if (_userId is null)
            {
                categories = [];
                return;
            }
            var res = await FinancialService.GetCategoriesByUserAsync(_userId.Value);
            if (res.Success && res.Data != null)
            {
                categories = res.Data.OrderBy(c => c.Name).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
        }
    }

    private async Task LoadTransactions()
    {
        isLoading = true;
        try
        {
            if (_userId is null)
            {
                transactions = [];
            }
            else
            {
                var result = await FinancialService.GetTransactionsByUserAsync(_userId.Value);
                if (result.Success && result.Data != null)
                {
                    transactions = result.Data.OrderByDescending(t => t.TransactionDate).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading transactions: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenCreateDialog()
    {
        editingTransaction = null;
        editModel = new TransactionEditModel();
        showDialog = true;
    }

    private void OpenCategoriesDialog()
    {
        categoryModel = new();
        showCategoriesDialog = true;
    }

    private void EditTransaction(TransactionDTO? transaction)
    {
        if (transaction == null) return;
        editingTransaction = transaction;
        editModel = new TransactionEditModel
        {
            Id = transaction.Id,
            Description = transaction.Description,
            Amount = transaction.Amount.Amount,
            Currency = transaction.Amount.Currency,
            TransactionType = transaction.TransactionType,
            CategoryId = transaction.Category?.Id,
            PaymentMethod = transaction.PaymentMethod,
            TransactionDate = transaction.TransactionDate,
            IsRecurring = transaction.IsRecurring
        };
        showDialog = true;
    }

    private async Task SaveTransaction()
    {
        try
        {
            if (_userId is null) return;
            var money = new Money(editModel.Amount, editModel.Currency);
            if (editingTransaction == null)
            {
                var create = new CreateTransactionCommand(_userId.Value, editModel.CategoryId, editModel.PaymentMethod, editModel.TransactionType, money, editModel.Description, editModel.TransactionDate, editModel.IsRecurring);
                await FinancialService.CreateTransactionAsync(create);
            }
            else
            {
                var update = new UpdateTransactionCommand(editModel.Id, editModel.CategoryId, editModel.PaymentMethod, editModel.TransactionType, money, editModel.Description, editModel.TransactionDate, editModel.IsRecurring);
                await FinancialService.UpdateTransactionAsync(update);
            }

            await LoadTransactions();
            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving transaction: {ex.Message}");
        }
    }

    private async Task CreateCategory()
    {
        try
        {
            if (_userId is null) return;
            var cmd = new CreateCategoryCommand(_userId.Value, categoryModel.Name, categoryModel.Description);
            var res = await FinancialService.CreateCategoryAsync(cmd);
            if (res.Success)
            {
                categoryModel = new();
                await LoadCategories();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating category: {ex.Message}");
        }
    }

    private async Task DeleteCategory(int id)
    {
        try
        {
            var res = await FinancialService.DeleteCategoryAsync(id);
            if (res.Success)
            {
                await LoadCategories();
                await LoadTransactions(); // caso apague categoria usada
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting category: {ex.Message}");
        }
    }

    private async Task DeleteTransaction(TransactionDTO? transaction)
    {
        if (transaction == null) return;

        try
        {
            await FinancialService.DeleteTransactionAsync(transaction.Id);
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting transaction: {ex.Message}");
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
        editingTransaction = null;
    }
}
