@page "/financial"
@using LifeSyncApp.Client.Services
@using LifeSyncApp.Client.Models.Financial
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@inject IFinancialService FinancialService

<PageTitle>Financeiro - LifeSync</PageTitle>

<div class="content-header">
    <div>
        <h1 class="page-title">Financeiro</h1>
        <p class="page-description">Controle suas finan?as pessoais</p>
    </div>
    <button class="btn btn-primary" @onclick="OpenCreateDialog">
        + Nova Transa??o
    </button>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-value">R$ @totalIncome.ToString("N2")</div>
                <div class="stat-label">Receitas</div>
            </div>
            <div class="stat-icon success">
                <span>?</span>
            </div>
        </div>
        <div class="stat-change positive">
            <span>+@incomeCount transa??es</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-value">R$ @totalExpenses.ToString("N2")</div>
                <div class="stat-label">Despesas</div>
            </div>
            <div class="stat-icon error">
                <span>?</span>
            </div>
        </div>
        <div class="stat-change negative">
            <span>-@expensesCount transa??es</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-value">R$ @balance.ToString("N2")</div>
                <div class="stat-label">Saldo</div>
            </div>
            <div class="stat-icon @(balance >= 0 ? "primary" : "warning")">
                <span>??</span>
            </div>
        </div>
        <div class="stat-change @(balance >= 0 ? "positive" : "negative")">
            <span>@(balance >= 0 ? "Positivo" : "Negativo")</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-value">@transactions.Count</div>
                <div class="stat-label">Total Transa??es</div>
            </div>
            <div class="stat-icon secondary">
                <span>??</span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        @if (isLoading)
        {
            <div style="text-align: center; padding: 3rem;">
                <div class="loading" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p style="margin-top: 1rem;">Carregando transa??es...</p>
            </div>
        }
        else if (transactions.Any())
        {
            <SfGrid DataSource="@transactions" AllowPaging="true" AllowSorting="true" AllowFiltering="true">
                <GridPageSettings PageSize="10"></GridPageSettings>
                <GridColumns>
                    <GridColumn Field="@nameof(TransactionDTO.Description)" HeaderText="Descri??o" Width="200"></GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.Amount)" HeaderText="Valor" Width="120"></GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.TransactionType)" HeaderText="Tipo" Width="100">
                        <Template>
                            @{
                                var transaction = context as TransactionDTO;
                                <span class="badge badge-@(transaction?.TransactionType == TransactionType.Income ? "success" : "error")">
                                    @(transaction?.TransactionType == TransactionType.Income ? "Receita" : "Despesa")
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.Category)" HeaderText="Categoria" Width="120"></GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.PaymentMethod)" HeaderText="M?todo" Width="120"></GridColumn>
                    <GridColumn Field="@nameof(TransactionDTO.TransactionDate)" HeaderText="Data" Width="120" Format="dd/MM/yyyy"></GridColumn>
                    <GridColumn HeaderText="A??es" Width="150">
                        <Template>
                            @{
                                var transaction = context as TransactionDTO;
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" @onclick="() => EditTransaction(transaction)">
                                        Editar
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteTransaction(transaction)">
                                        Excluir
                                    </button>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        }
        else
        {
            <div style="text-align: center; padding: 3rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
                <h3>Nenhuma transa??o encontrada</h3>
                <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">
                    Comece registrando sua primeira transa??o
                </p>
                <button class="btn btn-primary" @onclick="OpenCreateDialog">
                    + Nova Transa??o
                </button>
            </div>
        }
    </div>
</div>

<SfDialog @bind-Visible="showDialog" Width="500px" IsModal="true">
    <DialogTemplates>
        <Header>@(editingTransaction == null ? "Nova Transa??o" : "Editar Transa??o")</Header>
        <Content>
            <EditForm Model="editModel" OnValidSubmit="SaveTransaction" FormName="financialForm">
                <div class="form-group">
                    <label class="form-label">Descri??o</label>
                    <InputText @bind-Value="editModel.Description" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">Valor</label>
                    <InputNumber @bind-Value="editModel.Amount" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">Moeda</label>
                    <InputSelect @bind-Value="editModel.Currency" class="form-control">
                        @foreach (var c in Enum.GetValues<Currency>())
                        {
                            <option value="@c">@c</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <InputSelect @bind-Value="editModel.TransactionType" class="form-control">
                        @foreach (var t in Enum.GetValues<TransactionType>())
                        {
                            <option value="@t">@t</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">CategoriaId</label>
                    <InputNumber @bind-Value="editModel.CategoryId" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="form-label">M?todo de Pagamento</label>
                    <InputSelect @bind-Value="editModel.PaymentMethod" class="form-control">
                        @foreach (var m in Enum.GetValues<PaymentMethod>())
                        {
                            <option value="@m">@m</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Data</label>
                    <InputDate @bind-Value="editModel.TransactionDate" class="form-control" />
                </div>

                <div class="form-group">
                    <InputCheckbox @bind-Value="editModel.IsRecurring" />
                    <label class="form-label" style="margin-left: 0.5rem;">Recorrente</label>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDialog">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        @(editingTransaction == null ? "Criar" : "Salvar")
                    </button>
                </div>
            </EditForm>
        </Content>
    </DialogTemplates>
</SfDialog>

@code {
    private class TransactionEditModel
    {
        public int Id { get; set; }
        public string Description { get; set; } = string.Empty;
        public int Amount { get; set; }
        public Currency Currency { get; set; } = Currency.BRL;
        public TransactionType TransactionType { get; set; } = TransactionType.Expense;
        public int? CategoryId { get; set; }
        public PaymentMethod PaymentMethod { get; set; } = PaymentMethod.Cash;
        public DateTime TransactionDate { get; set; } = DateTime.Today;
        public bool IsRecurring { get; set; }
    }

    private List<TransactionDTO> transactions = new();

    [SupplyParameterFromForm]
    private TransactionEditModel editModel { get; set; } = new();

    private TransactionDTO? editingTransaction = null;
    private bool showDialog = false;
    private bool isLoading = true;

    private decimal totalIncome => transactions.Where(t => t.TransactionType == TransactionType.Income).Sum(t => (decimal)t.Amount.Amount);
    private decimal totalExpenses => transactions.Where(t => t.TransactionType == TransactionType.Expense).Sum(t => (decimal)t.Amount.Amount);
    private decimal balance => totalIncome - totalExpenses;
    private int incomeCount => transactions.Count(t => t.TransactionType == TransactionType.Income);
    private int expensesCount => transactions.Count(t => t.TransactionType == TransactionType.Expense);

    protected override async Task OnInitializedAsync()
    {
        await LoadTransactions();
    }

    private async Task LoadTransactions()
    {
        isLoading = true;
        try
        {
            var result = await FinancialService.GetTransactionsAsync();
            if (result.Success && result.Data != null)
            {
                transactions = result.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading transactions: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenCreateDialog()
    {
        editingTransaction = null;
        editModel = new TransactionEditModel();
        showDialog = true;
    }

    private void EditTransaction(TransactionDTO? transaction)
    {
        if (transaction == null) return;
        editingTransaction = transaction;
        editModel = new TransactionEditModel
        {
            Id = transaction.Id,
            Description = transaction.Description,
            Amount = transaction.Amount.Amount,
            Currency = transaction.Amount.Currency,
            TransactionType = transaction.TransactionType,
            CategoryId = transaction.Category?.Id,
            PaymentMethod = transaction.PaymentMethod,
            TransactionDate = transaction.TransactionDate,
            IsRecurring = transaction.IsRecurring
        };
        showDialog = true;
    }

    private async Task SaveTransaction()
    {
        try
        {
            var money = new Money(editModel.Amount, editModel.Currency);
            if (editingTransaction == null)
            {
                var create = new CreateTransactionCommand(0, editModel.CategoryId, editModel.PaymentMethod, editModel.TransactionType, money, editModel.Description, editModel.TransactionDate, editModel.IsRecurring);
                await FinancialService.CreateTransactionAsync(create);
            }
            else
            {
                var update = new UpdateTransactionCommand(editModel.Id, editModel.CategoryId, editModel.PaymentMethod, editModel.TransactionType, money, editModel.Description, editModel.TransactionDate, editModel.IsRecurring);
                await FinancialService.UpdateTransactionAsync(update);
            }

            await LoadTransactions();
            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving transaction: {ex.Message}");
        }
    }

    private async Task DeleteTransaction(TransactionDTO? transaction)
    {
        if (transaction == null) return;

        try
        {
            await FinancialService.DeleteTransactionAsync(transaction.Id);
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting transaction: {ex.Message}");
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
        editingTransaction = null;
    }
}
