@page "/register"
@using LifeSyncApp.Client.Services
@using LifeSyncApp.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-logo">
            <div class="auth-logo-icon">LS</div>
            <h1 class="auth-title">Crie sua conta</h1>
            <p class="auth-subtitle">Comece a organizar sua vida hoje</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-error">
                @errorMessage
            </div>
        }

        <EditForm Model="registerRequest" OnValidSubmit="HandleRegister" FormName="registerForm">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label class="form-label" for="firstName">Nome</label>
                <InputText @bind-Value="registerRequest.FirstName" 
                           class="form-control" 
                           id="firstName" 
                           placeholder="João" />
                <ValidationMessage For="@(() => registerRequest.FirstName)" />
            </div>

            <div class="form-group">
                <label class="form-label" for="lastName">Sobrenome</label>
                <InputText @bind-Value="registerRequest.LastName" 
                           class="form-control" 
                           id="lastName" 
                           placeholder="Silva" />
                <ValidationMessage For="@(() => registerRequest.LastName)" />
            </div>

            <div class="form-group">
                <label class="form-label" for="email">Email</label>
                <InputText @bind-Value="registerRequest.Email" 
                           class="form-control" 
                           id="email" 
                           placeholder="seu@email.com" />
                <ValidationMessage For="@(() => registerRequest.Email)" />
            </div>

            <div class="form-group">
                <label class="form-label" for="password">Senha</label>
                <InputText type="password" 
                           @bind-Value="registerRequest.Password" 
                           class="form-control" 
                           id="password" 
                           placeholder="••••••••" />
                <ValidationMessage For="@(() => registerRequest.Password)" />
            </div>

            <div class="form-group">
                <label class="form-label" for="confirmPassword">Confirmar Senha</label>
                <InputText type="password" 
                           @bind-Value="registerRequest.ConfirmPassword" 
                           class="form-control" 
                           id="confirmPassword" 
                           placeholder="••••••••" />
                <ValidationMessage For="@(() => registerRequest.ConfirmPassword)" />
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="width: 100%;" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="loading"></span>
                        <span>Criando conta...</span>
                    }
                    else
                    {
                        <span>Criar conta</span>
                    }
                </button>
            </div>
        </EditForm>

        <div class="auth-link">
            Já tem uma conta? <a href="/login">Faça login</a>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private RegisterRequest registerRequest { get; set; } = new();
    
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private async Task HandleRegister()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;

            if (registerRequest.Password != registerRequest.ConfirmPassword)
            {
                errorMessage = "As senhas não coincidem.";
                return;
            }

            var result = await AuthService.RegisterAsync(registerRequest);

            if (result.Success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = result.Errors?.Length > 0 
                    ? string.Join(", ", result.Errors) 
                    : "Erro ao criar conta. Tente novamente.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
