@page "/tasks"
@using LifeSyncApp.Client.Components.Shared
@using LifeSyncApp.Client.Services
@using LifeSyncApp.Client.Models.TaskManager
@using LifeSyncApp.Client.Models.TaskManager.TaskItem
@using LifeSyncApp.Client.Models.TaskManager.TaskLabel
@using LifeSyncApp.Client.Components.Tasks
@using Syncfusion.Blazor.Popups
@inject ITaskManagerService TaskService
@using System.Security.Claims

<PageTitle>Tarefas - LifeSync</PageTitle>

<RedirectToLogin>
    <PageHeader Title="Tarefas" Description="Gerencie suas tarefas e organize seu dia">
        <Actions>
            <div style="display:flex;gap:.5rem;">
                <button class="btn btn-primary" @onclick="OpenCreateDialog">
                    <span>➕ Nova Tarefa</span>
                </button>
            </div>
        </Actions>
    </PageHeader>

    <div class="stats-grid">
        <StatCard Label="Total" Value="@totalTasks.ToString()" IconStyle="primary" IconText="📋" />
        <StatCard Label="Pendentes" Value="@pendingTasks.ToString()" IconStyle="warning" IconText="⏳" />
        <StatCard Label="Em Progresso" Value="@inProgressTasks.ToString()" IconStyle="secondary" IconText="🔄" />
        <StatCard Label="Concluídas" Value="@completedTasksCount.ToString()" IconStyle="success" IconText="✅" />
    </div>

    <div class="card">
        <div class="card-body">
            @if (isLoading)
            {
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading" style="width: 40px; height: 40px; border-width: 4px;"></div>
                    <p style="margin-top: 1rem;">Carregando tarefas...</p>
                </div>
            }
            else if (tasks.Any())
            {
                <TaskFilters ActiveStatus="activeStatusFilter" ActivePriority="activePriorityFilter" OnStatusChanged="FilterByStatus" OnPriorityChanged="FilterByPriority" />

                <div class="tasks-container">
                    @foreach (var dateGroup in GetGroupedTasks())
                    {
                        <div class="tasks-date-section">
                            <div class="tasks-date-header">
                                @FormatDateHeader(dateGroup.Key)
                            </div>
                            <div class="tasks-grid">
                                @foreach (var task in dateGroup.Value)
                                {
                                    <TaskCard TaskItem="@task"
                                              OnEditClick="@(() => EditTask(task))"
                                              OnDeleteClick="@(() => DeleteTask(task))"
                                              OnAddLabelClick="@(() => OpenAddLabelDialog(task))" />
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
                    <h3>Nenhuma tarefa encontrada</h3>
                    <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">
                        Comece criando sua primeira tarefa
                    </p>
                    <button class="btn btn-primary" @onclick="OpenCreateDialog">
                        ➕ Nova Tarefa
                    </button>
                </div>
            }
        </div>
    </div>

    <TaskDialog Visible="showDialog" VisibleChanged="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<bool>(this, (bool v) => showDialog = v))" Header="@(editingTask == null ? "➕ Nova Tarefa" : "✏️ Editar Tarefa")" Model="currentTask" OnSubmit="SaveTask" OnCancel="CloseDialog" SubmitButtonText="@(editingTask == null ? "➕ Criar" : "💾 Salvar")">
        <div class="form-group">
            <label class="form-label">📝 Título</label>
            <InputText @bind-Value="currentTask.Title" class="form-control" />
        </div>

        <div class="form-group">
            <label class="form-label">📄 Descrição</label>
            <InputTextArea @bind-Value="currentTask.Description" class="form-control" />
        </div>

        <div class="form-group">
            <label class="form-label">🎯 Prioridade</label>
            <InputSelect @bind-Value="currentTask.Priority" class="form-control">
                @foreach (var p in Enum.GetValues<Priority>())
                {
                    <option value="@p">@p</option>
                }
            </InputSelect>
        </div>

        <div class="form-group">
            <label class="form-label">📅 Data de Vencimento</label>
            <InputDate DateFormat="dd/MM/yyyy" @bind-Value="currentTask.DueDate" class="form-control" />
        </div>
    </TaskDialog>

    <TaskDialog Visible="showAddLabelDialog" VisibleChanged="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<bool>(this, (bool v) => showAddLabelDialog = v))" Header="🏷️ Adicionar Label à Tarefa" Model="labelModel" OnSubmit="CreateLabelForTask" OnCancel="() => { showAddLabelDialog = false; labelModel = new LabelEditModel(); }" SubmitButtonText="➕ Adicionar">
        <div class="form-group">
            <label class="form-label">📝 Nome</label>
            <InputText @bind-Value="labelModel.Name" class="form-control" />
        </div>
        <div class="form-group">
            <label class="form-label">🎨 Cor</label>
            <InputSelect @bind-Value="labelModel.Color" class="form-control">
                @foreach (var c in Enum.GetValues<LabelColor>())
                {
                    <option value="@c">@c</option>
                }
            </InputSelect>
        </div>
    </TaskDialog>
</RedirectToLogin>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private int? _userId;

    private class TaskEditModel
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public Status Status { get; set; } = Status.Pending;
        public Priority Priority { get; set; } = Priority.Medium;
        public DateOnly DueDate { get; set; } = DateOnly.FromDateTime(DateTime.Today);
    }

    private class LabelEditModel
    {
        public string Name { get; set; } = string.Empty;
        public LabelColor Color { get; set; } = LabelColor.Purple;
    }

    private List<TaskItemDTO> tasks = new();
    private List<TaskLabelDTO> labels = new();

    [SupplyParameterFromForm]
    private TaskEditModel currentTask { get; set; } = new();

    private TaskItemDTO? editingTask = null;
    private bool showDialog = false;
    private bool isLoading = true;

    private bool showLabelsDialog = false;
    private bool showAddLabelDialog = false;
    private int? targetTaskIdForLabel = null;
    private LabelEditModel labelModel { get; set; } = new();

    private Status? activeStatusFilter = null;
    private Priority? activePriorityFilter = null;

    private int totalTasks => tasks.Count;
    private int pendingTasks => tasks.Count(t => t.Status == Status.Pending);
    private int inProgressTasks => tasks.Count(t => t.Status == Status.InProgress);
    private int completedTasksCount => tasks.Count(t => t.Status == Status.Completed);

    protected override async Task OnInitializedAsync()
    {
        await ResolveUserIdAsync();
        await LoadTasks();
        await LoadLabels();
    }

    private async Task ResolveUserIdAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        var idStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                   ?? user.FindFirst("UserId")?.Value
                   ?? user.FindFirst("sub")?.Value;
        if (int.TryParse(idStr, out var id))
            _userId = id;
    }

    private async Task LoadTasks()
    {
        isLoading = true;
        var result = await TaskService.GetTasksByUserAsync(_userId.Value);
        if (result.Success && result.Data != null)
            tasks = result.Data;
        isLoading = false;
        this.StateHasChanged();
    }

    private async Task LoadLabels()
    {
        var result = await TaskService.GetLabelsByUserAsync(_userId.Value);
        if (result.Success && result.Data != null)
            labels = result.Data;
        this.StateHasChanged();
    }

    private void FilterByStatus(Status? status)
    {
        activeStatusFilter = status;
    }

    private void FilterByPriority(Priority? priority)
    {
        activePriorityFilter = priority;
    }

    private IEnumerable<TaskItemDTO> GetFilteredTasks()
    {
        var filtered = tasks.AsEnumerable();

        if (activeStatusFilter.HasValue)
            filtered = filtered.Where(t => t.Status == activeStatusFilter.Value);

        if (activePriorityFilter.HasValue)
            filtered = filtered.Where(t => t.Priority == activePriorityFilter.Value);

        return filtered.OrderBy(t => t.DueDate);
    }

    private Dictionary<DateOnly, List<TaskItemDTO>> GetGroupedTasks()
    {
        return GetFilteredTasks()
            .GroupBy(t => t.DueDate)
            .OrderBy(g => g.Key)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private string FormatDateHeader(DateOnly date)
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var tomorrow = today.AddDays(1);
        var yesterday = today.AddDays(-1);

        if (date == today)
            return $"Hoje - {date:dd/MM/yyyy}";
        else if (date == tomorrow)
            return $"Amanhã - {date:dd/MM/yyyy}";
        else if (date == yesterday)
            return $"Ontem - {date:dd/MM/yyyy}";
        else if (date < today)
            return $"Atrasado - {date:dd/MM/yyyy}";
        else
            return date.ToString("dd/MM/yyyy - dddd");
    }

    private void OpenCreateDialog()
    {
        editingTask = null;
        currentTask = new TaskEditModel();
        showDialog = true;
    }

    private void EditTask(TaskItemDTO? task)
    {
        editingTask = task;
        currentTask = new TaskEditModel
        {
            Id = task.Id,
            Title = task.Title,
            Description = task.Description,
            Status = task.Status,
            Priority = task.Priority,
            DueDate = task.DueDate
        };
        showDialog = true;
        this.StateHasChanged();
    }

    private async Task SaveTask()
    {

        if (editingTask == null)
        {
            var create = new CreateTaskItemDTO(currentTask.Title, currentTask.Description, currentTask.Priority, currentTask.DueDate, _userId.Value);
            await TaskService.CreateTaskAsync(create);
        }
        else
        {
            var update = new UpdateTaskItemDTO(currentTask.Id, currentTask.Title, currentTask.Description, currentTask.Status, currentTask.Priority, currentTask.DueDate);
            await TaskService.UpdateTaskAsync(update);
        }

        await LoadTasks();
        CloseDialog();
        this.StateHasChanged();
    }

    private async Task DeleteTask(TaskItemDTO? task)
    {
        await TaskService.DeleteTaskAsync(task.Id);
        await LoadTasks();
        this.StateHasChanged();
    }

    private void CloseDialog()
    {
        showDialog = false;
        currentTask = new();
        editingTask = null;
    }

    private async Task CreateLabel()
    {
        var cmd = new CreateTaskLabelDTO(labelModel.Name, labelModel.Color, _userId.Value, 0);
        var res = await TaskService.CreateLabelAsync(cmd);
        if (res.Success)
            await LoadLabels();
        this.StateHasChanged();
    }

    private async Task DeleteLabel(int id)
    {
        var res = await TaskService.DeleteLabelAsync(id);
        if (!res.Success) return;

        await LoadLabels();
        await LoadTasks();

    }

    private void OpenAddLabelDialog(TaskItemDTO? task)
    {
        targetTaskIdForLabel = task.Id;
        labelModel = new();
        showAddLabelDialog = true;
        this.StateHasChanged();
    }

    private async Task CreateLabelForTask()
    {
        var cmd = new CreateTaskLabelDTO(labelModel.Name, labelModel.Color, _userId.Value, targetTaskIdForLabel.Value);
        var res = await TaskService.CreateLabelAsync(cmd);
        if (!res.Success) return;

        showAddLabelDialog = false;
        labelModel = new();
        await LoadTasks();
        this.StateHasChanged();
    }
}
