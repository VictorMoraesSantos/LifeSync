@page "/nutrition"
@using LifeSyncApp.Client.Services
@using LifeSyncApp.Client.Models.Nutrition
@using LifeSyncApp.Client.Components.Nutrition
@using LifeSyncApp.Client.Shared.Enums
@using Syncfusion.Blazor.Popups
@inject INutritionService NutritionService
@using System.Security.Claims

<PageTitle>Nutrição - LifeSync</PageTitle>

<RedirectToLogin>
    <PageHeader Title="Nutrição" Description="Acompanhe suas refeições e hidratação">
        <Actions>
            <div style="display:flex;gap:.5rem;">
                <button class="btn btn-primary" @onclick="EnsureTodayDiary">➕ Criar Diário de Hoje</button>
            </div>
        </Actions>
    </PageHeader>

    <div class="stats-grid">
        <StatCard Label="Calorias Hoje" Value="@todayCalories.ToString()" IconStyle="warning" IconText="🔥">
            <div class="stat-change">Meta: @goalCalories kcal</div>
        </StatCard>

        <StatCard Label="Refeições" Value="@todayMeals.ToString()" IconStyle="success" IconText="🍽️" />

        <StatCard Label="Líquidos" Value=@($"{todayLiquids:0.0} L") IconStyle="primary" IconText="💧">
            <div class="stat-change">Meta: @goalLiters.ToString("0.0") L</div>
        </StatCard>

        <StatCard Label="Dias Registrados" Value="@diariesCount.ToString()" IconStyle="secondary" IconText="📅" />
    </div>

    <div class="nutrition-layout">
        <div>
            @if (isLoadingMeals)
            {
                <div class="card">
                    <div class="card-body">
                        <div style="text-align: center; padding: 3rem;">
                            <div class="loading" style="width: 40px; height: 40px; border-width: 4px;"></div>
                            <p style="margin-top: 1rem;">Carregando diários...</p>
                        </div>
                    </div>
                </div>
            }
            else if (allDiaries.Any())
            {
                <DateFilters @bind-SelectedFilter="selectedDateFilter" />

                <div class="diaries-container">
                    @foreach (var dateGroup in GetGroupedDiaries())
                    {
                        <div class="diaries-date-section">
                            <div class="diaries-date-header">
                                @FormatDateHeader(dateGroup.Key)
                            </div>
                            @foreach (var diary in dateGroup.Value)
                            {
                                <DiaryCard Diary="@diary"
                                           OnAddMeal="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create(this, () => OpenAddMealDialog(diary)))"
                                           OnAddWater="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create(this, () => OpenAddWaterDialog(diary)))"
                                           OnEditMeal="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<LifeSyncApp.Client.Models.Nutrition.MealDTO>(this, (LifeSyncApp.Client.Models.Nutrition.MealDTO meal) => EditMeal(meal)))"
                                           OnAddFood="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<LifeSyncApp.Client.Models.Nutrition.MealDTO>(this, (LifeSyncApp.Client.Models.Nutrition.MealDTO meal) => OpenAddFoodDialog(meal)))"
                                           OnDeleteDiary="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<int>(this, (int id) => DeleteDiary(id)))"
                                           OnDeleteMeal="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<int>(this, (int id) => DeleteMeal(id)))"
                                           OnDeleteLiquid="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<int>(this, (int id) => DeleteLiquid(id)))"
                                           OnDeleteMealFood="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<int>(this, (int id) => DeleteMealFood(id)))" />
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body">
                        <div style="text-align: center; padding: 3rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
                            <h3>Nenhum diário encontrado</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Comece criando seu diário de hoje
                            </p>
                            <button class="btn btn-primary" @onclick="EnsureTodayDiary">
                                ➕ Criar Diário de Hoje
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div>
            <ProgressPanel CurrentCalories="@todayCalories"
                           GoalCalories="@goalCalories"
                           CurrentLiters="@todayLiquids"
                           GoalLiters="@goalLiters"
                           TotalMeals="@todayMeals"
                           TotalDays="@diariesCount"
                           OnEditGoals="@OpenGoalDialog"
                           OnAddWater="@AddWater" />
        </div>
    </div>

    <GoalDialog Visible="showGoalDialog" VisibleChanged="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<bool>(this, (bool v) => showGoalDialog = v))" InitialGoal="@(todayProgressId.HasValue ? new DailyGoalDTO(goalCalories, goalMl) : null)" OnSaveGoal="HandleSaveGoal" />

    <!-- Dialog de Adicionar Refeição (create or edit) -->
    <AddMealDialog Visible="showAddMealDialog"
                   VisibleChanged="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<bool>(this, (bool v) => showAddMealDialog = v))"
                   DiaryId="@(selectedDiary?.Id ?? 0)"
                   MealId="@(selectedMeal?.Id)"
                   InitialName="@(selectedMeal?.Name)"
                   InitialDescription="@(selectedMeal?.Description)"
                   OnSubmit="OnAddMealSubmit"
                   OnUpdate="OnUpdateMealSubmit">
    </AddMealDialog>

    <!-- Dialog de Adicionar Alimento -->
    <AddFoodDialog Visible="showAddFoodDialog" VisibleChanged="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<bool>(this, (bool v) => showAddFoodDialog = v))" MealId="@(selectedMeal?.Id ?? 0)" OnSubmit="OnAddFoodSubmit" />

    <!-- Dialog de Adicionar Água -->
    <AddWaterDialog Visible="showAddWaterDialog" VisibleChanged="@(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<bool>(this, (bool v) => showAddWaterDialog = v))" Name="@waterName" QuantityMl="@waterQuantity" OnSubmitWater="HandleAddWater" />
</RedirectToLogin>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;
    private int? _userId;

    private DateFilter selectedDateFilter = DateFilter.All;

    class MealModel
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }

    class FoodModel
    {
        public string Name { get; set; } = string.Empty;
        public int QuantityInGrams { get; set; }
        public int CaloriesPerUnit { get; set; }
    }

    private List<DiaryDTO> allDiaries = new();
    private DiaryDTO? todayDiary = null;
    private bool isLoadingMeals = true;
    private int diariesCount = 0;

    private int todayCalories => todayDiary?.TotalCalories ?? 0;
    private int todayMeals => todayDiary?.Meals.Count ?? 0;
    private decimal todayLiquids => (todayDiary?.Liquids.Sum(l => l.QuantityMl) ?? 0) / 1000m;

    // Objetivos e progresso diário
    private int goalCalories = 2000;
    private decimal goalLiters => goalMl / 1000m;
    private int goalMl = 2500;
    private int? todayProgressId = null;

    // Dialogs
    private bool showGoalDialog = false;
    private bool showAddMealDialog = false;
    private bool showAddFoodDialog = false;
    private bool showAddWaterDialog = false;

    // Models
    private MealModel mealModel = new();
    private FoodModel foodModel = new();
    private DiaryDTO? selectedDiary = null;
    private LifeSyncApp.Client.Models.Nutrition.MealDTO? selectedMeal = null;
    private string waterName = "Água";
    private int waterQuantity = 250;

    protected override async Task OnInitializedAsync()
    {
        await ResolveUserIdAsync();
        await LoadNutritionData();
        await EnsureDailyProgress();
    }

    private async Task ResolveUserIdAsync()
    {
        var auth = await AuthenticationStateTask;
        var user = auth.User;
        var idStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                   ?? user.FindFirst("UserId")?.Value
                   ?? user.FindFirst("sub")?.Value;
        if (int.TryParse(idStr, out var id))
            _userId = id;
    }

    private async Task LoadNutritionData()
    {
        isLoadingMeals = true;
        if (_userId is null)
        {
            allDiaries = new();
            todayDiary = null;
            diariesCount = 0;
            return;
        }

        var diariesResult = await NutritionService.GetDiariesByUserAsync(_userId.Value);
        if (diariesResult.Success && diariesResult.Data != null)
        {
            allDiaries = diariesResult.Data.OrderByDescending(d => d.Date).ToList();
            diariesCount = allDiaries.Count;
            var today = DateOnly.FromDateTime(DateTime.Today);
            todayDiary = allDiaries.FirstOrDefault(d => d.Date == today);
        }
        isLoadingMeals = false;
    }

    private IEnumerable<DiaryDTO> GetFilteredDiaries()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);

        return selectedDateFilter switch
        {
            DateFilter.Today => allDiaries.Where(d => d.Date == today),
            DateFilter.ThisWeek => allDiaries.Where(d => d.Date >= today.AddDays(-7)),
            DateFilter.ThisMonth => allDiaries.Where(d => d.Date.Month == today.Month && d.Date.Year == today.Year),
            _ => allDiaries
        };
    }

    private Dictionary<DateOnly, List<DiaryDTO>> GetGroupedDiaries()
    {
        return GetFilteredDiaries()
            .GroupBy(d => d.Date)
            .OrderByDescending(g => g.Key)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private string FormatDateHeader(DateOnly date)
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var yesterday = today.AddDays(-1);

        if (date == today)
            return $"📅 Hoje - {date:dd/MM/yyyy}";
        else if (date == yesterday)
            return $"🕐 Ontem - {date:dd/MM/yyyy}";
        else
            return $"📆 {date:dd/MM/yyyy - dddd}";
    }

    private async Task EnsureTodayDiary()
    {
        await EnsureDiaryInternal();
        await LoadNutritionData();
    }

    private async Task EnsureDiaryInternal()
    {
        if (_userId is null) return;
        var today = DateOnly.FromDateTime(DateTime.Today);
        if (todayDiary == null)
        {
            var create = new CreateDiaryCommand(_userId.Value, today);
            await NutritionService.CreateDiaryAsync(create);
        }
    }

    private async Task EnsureDailyProgress()
    {
        try
        {
            if (_userId is null) return;
            var res = await NutritionService.GetDailyProgressesByUserAsync(_userId.Value);
            var today = DateOnly.FromDateTime(DateTime.Today);
            var todayProgress = res.Success ? res.Data?.FirstOrDefault(p => p.Date == today) : null;
            if (todayProgress == null)
            {
                var create = new CreateDailyProgressCommand(_userId.Value, today, 0, 0);
                var created = await NutritionService.CreateDailyProgressAsync(create);
                if (created.Success)
                {
                    res = await NutritionService.GetDailyProgressesByUserAsync(_userId.Value);
                    todayProgress = res.Data?.FirstOrDefault(p => p.Date == today);
                }
            }

            if (todayProgress != null)
            {
                todayProgressId = todayProgress.Id;
                goalCalories = todayProgress.Goal?.Calories ?? goalCalories;
                goalMl = todayProgress.Goal?.QuantityMl ?? goalMl;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error ensuring daily progress: {ex.Message}");
        }
    }

    private void OpenAddMealDialog(DiaryDTO diary)
    {
        selectedDiary = diary;
        selectedMeal = null;
        mealModel = new MealModel();
        showAddMealDialog = true;
        this.StateHasChanged();
    }

    // Open dialog to edit an existing meal
    private void EditMeal(LifeSyncApp.Client.Models.Nutrition.MealDTO meal)
    {
        selectedMeal = meal;
        // select the parent diary so DiaryId param remains meaningful when adding new meals
        selectedDiary = allDiaries.FirstOrDefault(d => d.Meals.Any(m => m.Id == meal.Id));
        showAddMealDialog = true;
        this.StateHasChanged();
    }

    private async Task SaveMeal()
    {
        if (selectedDiary == null) return;
        var cmd = new CreateMealCommand(selectedDiary.Id, mealModel.Name, mealModel.Description);
        await NutritionService.AddMealAsync(cmd);
        await LoadNutritionData();
        showAddMealDialog = false;
        this.StateHasChanged();
    }

    private async Task OnAddMealSubmit(LifeSyncApp.Client.Models.Nutrition.Meal.CreateMealDTO dto)
    {
        var cmd = new CreateMealCommand(dto.DiaryId, dto.Name, dto.Description);
        var res = await NutritionService.AddMealAsync(cmd);
        Console.WriteLine($"[Nutrition] AddMeal response: Success={res.Success}; Errors={string.Join(';', res.Errors ?? new string[0])}");
        await LoadNutritionData();
    }

    private async Task OnUpdateMealSubmit(LifeSyncApp.Client.Models.Nutrition.Meal.UpdateMealDTO dto)
    {
        var res = await NutritionService.UpdateMealAsync(dto);
        Console.WriteLine($"[Nutrition] UpdateMeal response: Success={res.Success}; Errors={string.Join(';', res.Errors ?? new string[0])}");
        if (res.Success)
        {
            await LoadNutritionData();
        }
        showAddMealDialog = false;
        selectedMeal = null;
    }

    private void OpenAddFoodDialog(LifeSyncApp.Client.Models.Nutrition.MealDTO meal)
    {
        selectedMeal = meal;
        foodModel = new FoodModel();
        showAddFoodDialog = true;
        this.StateHasChanged();
    }

    private async Task SaveFood()
    {
        if (selectedMeal == null) return;
        var cmd = new CreateMealFoodCommand(selectedMeal.Id, foodModel.Name, foodModel.QuantityInGrams, foodModel.CaloriesPerUnit);
        await NutritionService.AddMealFoodAsync(selectedMeal.Id, cmd);
        await LoadNutritionData();
        showAddFoodDialog = false;
        this.StateHasChanged();
    }

    private void OpenAddWaterDialog(DiaryDTO diary)
    {
        selectedDiary = diary;
        waterName = "Água";
        waterQuantity = 250;
        showAddWaterDialog = true;
        this.StateHasChanged();
    }

    private async Task SaveWater()
    {
        if (selectedDiary == null) return;
        var liquid = new CreateLiquidCommand(selectedDiary.Id, waterName, waterQuantity, 0);
        await NutritionService.AddLiquidAsync(liquid);
        await LoadNutritionData();
        showAddWaterDialog = false;
        this.StateHasChanged();
    }

    private async Task AddWater(int ml)
    {
        await EnsureDiaryInternal();
        if (todayDiary == null) return;
        var liquid = new CreateLiquidCommand(todayDiary.Id, "Água", ml, 0);
        await NutritionService.AddLiquidAsync(liquid);
        await LoadNutritionData();
        this.StateHasChanged();
    }

    private void OpenGoalDialog()
    {
        showGoalDialog = true;
    }

    private async Task SaveGoal()
    {
        if (todayProgressId is null) return;
        var goal = new DailyGoalDTO(goalCalories, goalMl);
        await NutritionService.SetGoalAsync(todayProgressId.Value, goal);
        showGoalDialog = false;
        this.StateHasChanged();
    }

    private async Task DeleteDiary(int id)
    {
        var res = await NutritionService.DeleteDiaryAsync(id);
        if (res.Success)
            await LoadNutritionData();
    }

    private async Task DeleteMeal(int id)
    {
        var res = await NutritionService.DeleteMealAsync(id);
        if (res.Success)
            await LoadNutritionData();
    }

    private async Task DeleteLiquid(int id)
    {
        var res = await NutritionService.DeleteLiquidAsync(id);
        if (res.Success)
            await LoadNutritionData();
    }

    private async Task DeleteMealFood(int id)
    {
        var res = await NutritionService.DeleteMealFoodAsync(id);
        if (res.Success)
            await LoadNutritionData();
    }

    private async Task HandleSaveGoal(DailyGoalDTO goal)
    {
        if (todayProgressId is null) return;
        await NutritionService.SetGoalAsync(todayProgressId.Value, goal);
        await EnsureDailyProgress();
    }

    private async Task OnAddFoodSubmit(LifeSyncApp.Client.Models.Nutrition.MealFood.CreateMealFoodDTO dto)
    {
        var cmd = new CreateMealFoodCommand(dto.MealId, dto.Name, dto.QuantityInGrams, dto.CaloriesPerUnit);
        var res = await NutritionService.AddMealFoodAsync(dto.MealId, cmd);
        Console.WriteLine($"[Nutrition] AddMealFood response: Success={res.Success}; Errors={string.Join(';', res.Errors ?? new string[0])}");
        await LoadNutritionData();
    }

    private async Task HandleAddWater((string Name, int Quantity) tuple)
    {
        if (selectedDiary == null) return;
        var (n, q) = tuple;
        var cmd = new CreateLiquidCommand(selectedDiary.Id, n, q, 0);
        await NutritionService.AddLiquidAsync(cmd);
        await LoadNutritionData();
    }
}
